<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MuzzSnap</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff0000">

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- Web3 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<!-- React -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{background:#0a0a0a;color:#fff;font-family:Inter,system-ui}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useRef}=React;

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  authDomain:"pulsari.firebaseapp.com",
  databaseURL:"https://pulsari-default-rtdb.firebaseio.com",
  projectId:"pulsari"
});
const db=firebase.database();
firebase.auth().signInAnonymously();

/* ================= CONFIG ================= */
const CONFIG={
  contractAddress:"0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0",
  minTokens:40000000,
  requiredChainId:1
};

/* ================= APP ================= */
function App(){
  const [stage,setStage]=useState("login"); // login | chat
  const [wallet,setWallet]=useState(null);
  const [messages,setMessages]=useState([]);
  const [text,setText]=useState("");
  const scrollRef=useRef();

  /* ===== RESTORE SESSION ===== */
  useEffect(()=>{
    const addr=localStorage.getItem("muzz_wallet");
    if(addr){
      setWallet(addr);
      setStage("chat");
    }
  },[]);

  /* ===== LOGIN ===== */
  const connectWallet=async()=>{
    if(!window.ethereum){
      alert("Wallet requerida");
      return;
    }

    const provider=new ethers.providers.Web3Provider(window.ethereum,"any");
    const accounts=await provider.send("eth_requestAccounts",[]);
    const address=accounts[0];

    const network=await provider.getNetwork();
    if(network.chainId!==CONFIG.requiredChainId){
      alert("Switch to Ethereum Mainnet");
      return;
    }

    const abi=[
      "function balanceOf(address) view returns(uint256)",
      "function decimals() view returns(uint8)"
    ];

    const contract=new ethers.Contract(CONFIG.contractAddress,abi,provider);
    const decimals=await contract.decimals();
    const balance=Number(ethers.utils.formatUnits(
      await contract.balanceOf(address),
      decimals
    ));

    if(balance<CONFIG.minTokens){
      alert("Insufficient MUZZ balance");
      return;
    }

    localStorage.setItem("muzz_wallet",address);
    setWallet(address);
    setStage("chat");
  };

  /* ===== CHAT ===== */
  useEffect(()=>{
    if(stage!=="chat") return;
    db.ref("messages/general").limitToLast(50).on("value",s=>{
      const v=s.val()||{};
      setMessages(Object.keys(v).map(k=>({id:k,...v[k]})));
    });
  },[stage]);

  useEffect(()=>{
    scrollRef.current?.scrollIntoView({behavior:"smooth"});
  },[messages]);

  const send=async()=>{
    if(!text.trim())return;
    await db.ref("messages/general").push({
      content:text,
      wallet,
      time:Date.now()
    });
    setText("");
  };

  /* ===== UI ===== */
  if(stage==="login"){
    return(
      <div className="h-screen flex flex-col items-center justify-center text-center p-6">
        <img
          src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png"
          className="w-40 h-40 rounded-2xl mb-6 cursor-pointer"
          onClick={connectWallet}
        />
        <h1 className="text-3xl font-black mb-2">MuzzSnap</h1>
        <p className="text-xs text-gray-400">
          Click logo to connect wallet
        </p>
      </div>
    );
  }

  return(
    <div className="h-screen flex flex-col p-4">
      <header className="text-xs opacity-50 mb-2">
        Wallet: {wallet.slice(0,6)}…{wallet.slice(-4)}
      </header>

      <div className="flex-1 overflow-y-auto space-y-3">
        {messages.map(m=>(
          <div key={m.id} className={m.wallet===wallet?"text-right":""}>
            <div className="inline-block bg-gray-800 px-4 py-2 rounded-xl">
              {m.content}
            </div>
          </div>
        ))}
        <div ref={scrollRef}></div>
      </div>

      <div className="flex gap-2 mt-3">
        <input
          className="flex-1 bg-gray-900 p-3 rounded-xl"
          value={text}
          onChange={e=>setText(e.target.value)}
          onKeyDown={e=>e.key==="Enter"&&send()}
          placeholder="Transmit…"
        />
        <button
          className="px-4 bg-red-600 rounded-xl"
          onClick={send}
        >
          <i className="fas fa-bolt"></i>
        </button>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
