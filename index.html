<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzzSnap | Acceso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: white; }
        .muzz-background { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 10% 50%, rgba(100, 100, 100, 0.08) 0%, transparent 50%); }
        #logoButton { cursor: pointer; transition: transform 0.3s ease; }
        .pulse-ring { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4">
    <div class="muzz-background"></div>

    <div id="statusContainer" class="absolute top-4 right-4 z-20">
        <span id="walletStatus" class="py-2 px-4 text-xs font-medium text-gray-400 bg-gray-800 rounded-lg border border-gray-700">
            <i class="fas fa-circle text-gray-500 mr-1"></i> Desconectado
        </span>
    </div>

    <div class="relative z-10 flex flex-col items-center justify-center min-h-[80vh] max-w-sm mx-auto text-center">
        <div id="logoButton" onclick="connectWallet()" class="mb-6 relative">
            <img id="muzzLogo" src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png" 
                 alt="MuzzSnap" class="w-40 h-40 rounded-2xl shadow-2xl">
            <div id="loadingSpinner" class="hidden absolute inset-0 flex items-center justify-center bg-black/60 rounded-2xl">
                <i class="fas fa-spinner fa-spin text-4xl text-white"></i>
            </div>
        </div>

        <h1 class="text-4xl font-black mb-2 tracking-tight">MuzzSnap</h1>
        <p class="text-xs text-gray-500 mb-8 uppercase tracking-widest">Chat Seguro Descentralizado</p>

        <div id="messageArea" class="hidden w-full mb-8 p-4 bg-red-900/20 border border-red-800/50 rounded-xl">
            <p id="messageTitle" class="text-sm font-bold text-red-400 mb-1">Aviso</p>
            <p id="messageText" class="text-xs text-gray-400"></p>
        </div>

        <p class="text-xs text-gray-600 pulse-ring">Toca el logo para abrir tu Wallet<br>ロゴをクリックしてウォレットを開く</p>
    </div>

    <script>
        const CONFIG = {
            contractAddress: "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0",
            minTokens: 40000000,
            requiredChainId: 1,
            chatUrl: 'chat.html'
        };

        const ERC20_ABI = ["function balanceOf(address) view returns (uint256)", "function decimals() view returns (uint8)"];

        async function connectWallet() {
            const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
            const hasWeb3 = typeof window.ethereum !== 'undefined';
            
            document.getElementById('loadingSpinner').classList.remove('hidden');

            try {
                // LÓGICA DE REDIRECCIÓN MÓVIL (Deep Linking)
                if (isMobile && !hasWeb3) {
                    const dappUrl = window.location.host + window.location.pathname;
                    
                    // Intento 1: MetaMask
                    window.location.href = `https://metamask.app.link/dapp/${dappUrl}`;
                    
                    // Intento 2: Trust Wallet (si no abre MM en 2.5 seg)
                    setTimeout(() => {
                        window.location.href = `https://link.trustwallet.com/open_url?url=${encodeURIComponent(window.location.href)}`;
                    }, 2500);
                    return;
                }

                // CONEXIÓN WEB3 (Navegador PC o Navegador interno de Wallet)
                if (!hasWeb3) throw new Error("Wallet no detectada. Instala MetaMask o Trust Wallet.");

                const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                const address = await signer.getAddress();

                // 1. Firma obligatoria para el chat
                const signature = await signer.signMessage(`MuzzSnap Login: ${address}`);

                // 2. Verificación de Balance
                const contract = new ethers.Contract(CONFIG.contractAddress, ERC20_ABI, provider);
                const balance = await contract.balanceOf(address);
                const decimals = await contract.decimals();
                const total = parseFloat(ethers.utils.formatUnits(balance, decimals));

                if (total < CONFIG.minTokens) throw new Error(`Mínimo 40M MUZZ requeridos.`);

                // Guardar sesión y entrar
                sessionStorage.setItem('muzz_wallet', address);
                sessionStorage.setItem('muzz_sig', signature);
                window.location.href = CONFIG.chatUrl;

            } catch (err) {
                const msgArea = document.getElementById('messageArea');
                msgArea.classList.remove('hidden');
                document.getElementById('messageText').textContent = err.message;
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
