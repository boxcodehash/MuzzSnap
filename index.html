<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Muzzle Secure Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { background:#000;color:#fff;font-family:sans-serif;text-align:center;padding-top:60px }
button { padding:12px 25px;font-size:18px;background:#6d28d9;color:#fff;border:none;border-radius:8px }
</style>
</head>

<body>

<h1>MuzzSnap Secure Access</h1>
<p id="status">Connect wallet to continue</p>
<button onclick="login()">Connect Wallet</button>

<script>
/* üîê FIREBASE */
firebase.initializeApp({
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT"
});
const db = firebase.database();

/* üîê TOKEN CONFIG */
const TOKEN_ADDRESS = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
const MIN_BALANCE = 20000000;
const ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];

async function login(){
  try{
    if(!window.ethereum) throw "Wallet not detected";

    const provider = new ethers.providers.Web3Provider(window.ethereum,"any");
    await provider.send("eth_requestAccounts",[]);
    const signer = provider.getSigner();
    const address = await signer.getAddress();

    document.getElementById("status").innerText = "Checking balance‚Ä¶";

    const token = new ethers.Contract(TOKEN_ADDRESS, ABI, provider);
    const bal = await token.balanceOf(address);
    const dec = await token.decimals();
    const realBal = parseFloat(ethers.utils.formatUnits(bal,dec));

    if(realBal < MIN_BALANCE) throw "Insufficient MUZZLE";

    const msg = `Login MuzzSnap ${Date.now()}`;
    const signature = await signer.signMessage(msg);
    const recovered = ethers.utils.verifyMessage(msg, signature);

    if(recovered.toLowerCase() !== address.toLowerCase()) throw "Signature failed";

    await db.ref("sessions/"+address).set({
      address,
      time: Date.now()
    });

    localStorage.setItem("wallet", address);
    window.location.href = "chat.html";

  }catch(e){
    alert(e);
    document.getElementById("status").innerText = "Access denied";
  }
}
</script>

</body>
</html>
