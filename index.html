<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MuzzSnap Secure Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ethers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
}
.box {
  background:#111;
  padding:30px;
  border-radius:14px;
  width:340px;
  text-align:center;
}
button {
  width:100%;
  padding:14px;
  margin-top:20px;
  font-size:16px;
  background:#6d28d9;
  color:#fff;
  border:none;
  border-radius:8px;
}
button:disabled {
  opacity:0.4;
}
#status {
  margin-top:15px;
  font-size:14px;
  opacity:0.9;
}
.small {
  font-size:12px;
  opacity:0.6;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="box">
  <h2>MuzzSnap Access</h2>
  <p>Wallet connection required</p>
  <button id="loginBtn">Connect Wallet</button>
  <div id="status"></div>
  <div class="small">
    Desktop: Chrome / Brave / Edge<br>
    Mobile: MetaMask Browser
  </div>
</div>

<script>
/* =========================
   üî• FIREBASE CONFIG
========================= */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT_ID"
});
const db = firebase.database();

/* =========================
   ü™ô TOKEN CONFIG
========================= */
const TOKEN_ADDRESS = "0xEF3DAA5FDA8AD7AABFF4658F1F78061FD626B8F0";
const MIN_BALANCE = 20000000;
const TOKEN_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];

/* =========================
   ü¶ä WALLET DETECTION (FIX REAL)
========================= */
function getEthereumProvider() {
  if (typeof window.ethereum !== "undefined") return window.ethereum;
  if (window.web3 && window.web3.currentProvider) return window.web3.currentProvider;
  return null;
}

/* =========================
   üîê LOGIN FLOW
========================= */
const btn = document.getElementById("loginBtn");
const statusEl = document.getElementById("status");

btn.onclick = async () => {
  try {
    const eth = getEthereumProvider();

    if (!eth) {
      alert(
        "Wallet not detected.\n\n" +
        "‚úî Desktop: Chrome / Brave with MetaMask\n" +
        "‚úî Mobile: Open inside MetaMask Browser\n\n" +
        "‚ùå In-app browsers not supported"
      );
      return;
    }

    btn.disabled = true;
    statusEl.innerText = "Requesting wallet access‚Ä¶";

    const provider = new ethers.providers.Web3Provider(eth, "any");
    await provider.send("eth_requestAccounts", []);

    const signer = provider.getSigner();
    const address = await signer.getAddress();

    statusEl.innerText = "Checking MUZZLE balance‚Ä¶";

    const token = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, provider);
    const raw = await token.balanceOf(address);
    const dec = await token.decimals();
    const balance = parseFloat(ethers.utils.formatUnits(raw, dec));

    if (balance < MIN_BALANCE) {
      throw "Minimum 20,000,000 MUZZLE required";
    }

    statusEl.innerText = "Signing message‚Ä¶";

    const nonce = Date.now();
    const message =
      "MuzzSnap Login\n" +
      "Wallet: " + address + "\n" +
      "Nonce: " + nonce;

    const signature = await signer.signMessage(message);
    const recovered = ethers.utils.verifyMessage(message, signature);

    if (recovered.toLowerCase() !== address.toLowerCase()) {
      throw "Signature verification failed";
    }

    statusEl.innerText = "Creating secure session‚Ä¶";

    await db.ref("sessions/" + address.toLowerCase()).set({
      wallet: address.toLowerCase(),
      createdAt: Date.now(),
      nonce
    });

    localStorage.setItem("wallet", address.toLowerCase());

    statusEl.innerText = "Access granted ‚úî";
    setTimeout(() => {
      window.location.href = "chat.html";
    }, 700);

  } catch (err) {
    console.error(err);
    alert(err);
    statusEl.innerText = "Access denied";
    btn.disabled = false;
  }
};
</script>
</body>
</html>
