<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pulsari Secure Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ethers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<!-- WalletConnect v2 (MOBILE SAFE) -->
<script src="https://unpkg.com/@walletconnect/ethereum-provider@2.11.1/dist/ethereum-provider.umd.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.box{
  background:#111;
  padding:30px;
  border-radius:16px;
  width:340px;
  text-align:center;
}
button{
  width:100%;
  padding:15px;
  margin-top:16px;
  background:#6d28d9;
  border:none;
  border-radius:10px;
  font-size:16px;
  color:#fff;
}
#status{
  margin-top:14px;
  min-height:18px;
  font-size:14px;
}
.small{
  font-size:12px;
  opacity:.6;
  margin-top:12px;
}
</style>
</head>

<body>
<div class="box">
  <h2>Pulsari Access</h2>

  <!-- ðŸ”¥ UN SOLO BOTÃ“N -->
  <button onclick="connectWallet()">Connect Wallet</button>

  <div id="status"></div>

  <div class="small">
    Mobile & Desktop<br>
    MetaMask Â· Crypto Â· Trust Â· OKX Â· Rainbow
  </div>
</div>

<script>
/* =========================
   ðŸ”¥ FIREBASE CONFIG
========================= */
firebase.initializeApp({
  apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  projectId: "pulsari"
});

const auth = firebase.auth();
const functions = firebase.functions();

/* =========================
   ðŸ”— WALLETCONNECT CONFIG
========================= */
const WC_PROJECT_ID = "cbb8c131e6f916a235b0825e181ab0c9";

/* =========================
   ðŸ” MOBILE DETECTION
========================= */
function isMobile() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

/* =========================
   ðŸš€ CONNECT WALLET (AUTO)
========================= */
async function connectWallet() {
  try {
    setStatus("Connecting walletâ€¦");

    let provider;

    // âœ… Desktop (MetaMask injected)
    if (window.ethereum && !isMobile()) {
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
    } 
    // âœ… Mobile / Crypto Wallet / Brave
    else {
      const WCProvider =
        window.WalletConnectEthereumProvider ||
        window.EthereumProvider;

      if (!WCProvider) {
        throw "WalletConnect not available";
      }

      const wc = await WCProvider.init({
        projectId: WC_PROJECT_ID,
        chains: [1],
        showQrModal: true
      });

      await wc.enable();
      provider = new ethers.providers.Web3Provider(wc, "any");
    }

    await loginSIWE(provider);

  } catch (err) {
    console.error(err);
    alert(err);
    setStatus("Connection failed");
  }
}

/* =========================
   ðŸ” SIWE LOGIN
========================= */
async function loginSIWE(provider) {
  try {
    const signer = provider.getSigner();
    const wallet = await signer.getAddress();

    const nonce = Math.random().toString(36).substring(2);

    const message =
`pulsari.app wants you to sign in with your Ethereum account:
${wallet}

URI: https://pulsari.app
Version: 1
Chain ID: 1
Nonce: ${nonce}
Issued At: ${new Date().toISOString()}`;

    setStatus("Signing messageâ€¦");

    const signature = await signer.signMessage(message);

    setStatus("Verifying accessâ€¦");

    const result = await functions
      .httpsCallable("loginSIWE")({
        wallet,
        message,
        signature
      });

    await auth.signInWithCustomToken(result.data.token);

    setStatus("Access granted âœ”");

    setTimeout(() => {
      window.location.href = "chat.html";
    }, 600);

  } catch (err) {
    console.error(err);
    alert(err);
    setStatus("Access denied");
  }
}

function setStatus(text) {
  document.getElementById("status").innerText = text;
}
</script>
</body>
</html>
