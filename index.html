<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Secure Web3 authentication for Pulsari platform">
<meta name="theme-color" content="#6d28d9">

<!-- Open Graph / Professional metadata -->
<meta property="og:title" content="Pulsari - Web3 Login">
<meta property="og:description" content="Connect your wallet to access Pulsari">
<meta property="og:type" content="website">

<title>Pulsari - Connect Wallet</title>

<!-- Ethers.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
  background:linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  color:#fff;
}

.container{
  width:100%;
  max-width:440px;
}

.card{
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:24px;
  padding:40px 32px;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
}

.logo{
  text-align:center;
  margin-bottom:32px;
}

.logo-icon{
  width:64px;
  height:64px;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius:16px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
  margin-bottom:16px;
  box-shadow:0 8px 24px rgba(102,126,234,0.3);
}

h1{
  font-size:28px;
  font-weight:700;
  margin-bottom:8px;
  text-align:center;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

.subtitle{
  text-align:center;
  color:rgba(255,255,255,0.6);
  font-size:14px;
  margin-bottom:32px;
}

.connect-btn{
  width:100%;
  padding:18px;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border:none;
  border-radius:12px;
  color:#fff;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  box-shadow:0 4px 16px rgba(102,126,234,0.4);
}

.connect-btn:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 6px 24px rgba(102,126,234,0.5);
}

.connect-btn:active:not(:disabled){
  transform:translateY(0);
}

.connect-btn:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

.wallet-icon{
  font-size:24px;
}

.status{
  margin-top:20px;
  padding:16px;
  background:rgba(255,255,255,0.05);
  border-radius:12px;
  text-align:center;
  font-size:14px;
  min-height:52px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:rgba(255,255,255,0.8);
}

.status.loading{
  animation:pulse 1.5s ease-in-out infinite;
}

@keyframes pulse{
  0%, 100%{opacity:1;}
  50%{opacity:0.5;}
}

.features{
  margin-top:32px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}

.feature{
  text-align:center;
  padding:16px 8px;
  background:rgba(255,255,255,0.03);
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.05);
}

.feature-icon{
  font-size:24px;
  margin-bottom:8px;
}

.feature-text{
  font-size:12px;
  color:rgba(255,255,255,0.6);
  line-height:1.4;
}

.footer{
  margin-top:24px;
  text-align:center;
  font-size:12px;
  color:rgba(255,255,255,0.4);
}

.supported-wallets{
  margin-top:24px;
  padding-top:24px;
  border-top:1px solid rgba(255,255,255,0.1);
}

.supported-title{
  font-size:12px;
  color:rgba(255,255,255,0.5);
  text-align:center;
  margin-bottom:12px;
}

.wallet-logos{
  display:flex;
  justify-content:center;
  gap:16px;
  flex-wrap:wrap;
}

.wallet-logo{
  width:32px;
  height:32px;
  background:rgba(255,255,255,0.1);
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}

.hidden{
  display:none !important;
}
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <div class="logo">
      <div class="logo-icon">üîê</div>
      <h1>Pulsari</h1>
      <p class="subtitle">Secure Web3 Authentication</p>
    </div>

    <!-- Bot√≥n de Conexi√≥n -->
    <button id="connectBtn" class="connect-btn" onclick="connectWallet()">
      <span class="wallet-icon">üîó</span>
      <span id="btnText">Connect Wallet</span>
    </button>

    <!-- Estado -->
    <div id="status" class="status" style="display:none;">
      Ready to connect
    </div>

    <!-- Features -->
    <div class="features">
      <div class="feature">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">Secure<br>Sign-in</div>
      </div>
      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-text">Fast<br>Access</div>
      </div>
      <div class="feature">
        <div class="feature-icon">üõ°Ô∏è</div>
        <div class="feature-text">No<br>Passwords</div>
      </div>
    </div>

    <!-- Wallets Soportadas -->
    <div class="supported-wallets">
      <div class="supported-title">Supported Wallets</div>
      <div class="wallet-logos">
        <div class="wallet-logo" title="MetaMask">ü¶ä</div>
        <div class="wallet-logo" title="Trust Wallet">üõ°Ô∏è</div>
        <div class="wallet-logo" title="Coinbase">üíô</div>
        <div class="wallet-logo" title="Rainbow">üåà</div>
        <div class="wallet-logo" title="Crypto.com">üíé</div>
      </div>
    </div>

    <div class="footer">
      Powered by Ethereum ¬∑ SIWE Authentication
    </div>
  </div>
</div>

<script>
console.log('üöÄ Pulsari Login v2.0');

/* Firebase Configuration */
const firebaseConfig = {
  apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  projectId: "pulsari"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const functions = firebase.functions();

/* UI Elements */
const connectBtn = document.getElementById('connectBtn');
const btnText = document.getElementById('btnText');
const statusDiv = document.getElementById('status');

/* Helper Functions */
function setStatus(message, isLoading = false) {
  statusDiv.style.display = 'flex';
  statusDiv.textContent = message;
  statusDiv.className = isLoading ? 'status loading' : 'status';
  console.log('üìä', message);
}

function setBtnText(text) {
  btnText.textContent = text;
}

function disableBtn(disabled) {
  connectBtn.disabled = disabled;
}

/* Main Connect Function */
async function connectWallet() {
  try {
    disableBtn(true);
    setStatus('Initializing connection...', true);

    // Check if provider exists
    if (!window.ethereum) {
      setStatus('No wallet detected');
      alert('Please install a Web3 wallet (MetaMask, Trust, etc.) or open this page inside your wallet\'s browser.\n\nFor mobile: Open your wallet app ‚Üí Browser ‚Üí Paste this URL');
      disableBtn(false);
      return;
    }

    console.log('‚úÖ Wallet provider detected:', window.ethereum.isMetaMask ? 'MetaMask' : 'Web3');

    setStatus('Connecting to wallet...', true);
    setBtnText('Requesting access...');

    // Create provider
    const provider = new ethers.providers.Web3Provider(window.ethereum, "any");

    // Request account access
    const accounts = await provider.send("eth_requestAccounts", []);
    
    if (!accounts || accounts.length === 0) {
      throw new Error('No accounts returned from wallet');
    }

    console.log('‚úÖ Accounts received:', accounts[0]);

    // Proceed with SIWE
    await performSIWE(provider);

  } catch (error) {
    console.error('‚ùå Connection error:', error);
    
    if (error.code === 4001 || error.code === 'ACTION_REJECTED') {
      setStatus('Connection rejected by user');
      alert('You rejected the connection request. Please try again and approve the connection.');
    } else if (error.message && error.message.includes('User rejected')) {
      setStatus('Connection rejected');
    } else {
      setStatus('Connection failed: ' + (error.message || error));
      alert('Connection failed:\n' + (error.message || error.toString()));
    }

    setBtnText('Connect Wallet');
    disableBtn(false);
  }
}

/* SIWE Authentication */
async function performSIWE(provider) {
  try {
    const signer = provider.getSigner();
    const address = await signer.getAddress();
    
    console.log('üìù Connected address:', address);
    
    setStatus('Preparing signature...', true);
    setBtnText('Signing...');

    // Create SIWE message
    const nonce = Math.random().toString(36).substring(2, 15);
    const timestamp = new Date().toISOString();
    
    const message = `pulsari.app wants you to sign in with your Ethereum account:
${address}

Sign in to Pulsari to access your account.

URI: https://pulsari.app
Version: 1
Chain ID: 1
Nonce: ${nonce}
Issued At: ${timestamp}`;

    console.log('üìÑ SIWE Message prepared');

    // Request signature
    setStatus('Please sign the message in your wallet...', true);
    
    const signature = await signer.signMessage(message);
    
    console.log('‚úÖ Message signed successfully');
    
    setStatus('Verifying signature...', true);
    setBtnText('Verifying...');

    // Call Firebase function
    const result = await functions.httpsCallable('loginSIWE')({
      wallet: address,
      message: message,
      signature: signature
    });

    console.log('‚úÖ Signature verified by server');

    // Sign in to Firebase
    await auth.signInWithCustomToken(result.data.token);
    
    console.log('‚úÖ Firebase authentication successful');
    
    setStatus('‚úÖ Authentication successful!');
    setBtnText('Redirecting...');

    // Redirect to chat
    setTimeout(() => {
      window.location.href = 'chat.html';
    }, 1000);

  } catch (error) {
    console.error('‚ùå SIWE error:', error);
    
    if (error.code === 4001 || error.code === 'ACTION_REJECTED') {
      setStatus('Signature rejected');
      alert('You rejected the signature request. Please try again and sign the message to continue.');
    } else {
      setStatus('Authentication failed');
      alert('Authentication failed:\n' + (error.message || error.toString()));
    }
    
    setBtnText('Connect Wallet');
    disableBtn(false);
    throw error;
  }
}

/* Auto-detect if already in wallet browser */
window.addEventListener('load', () => {
  if (window.ethereum) {
    console.log('‚úÖ Wallet provider detected on page load');
    setStatus('Wallet detected - ready to connect');
  } else {
    console.log('‚ö†Ô∏è No wallet provider detected');
  }
});
</script>

</body>
</html>
