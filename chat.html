<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Tactical Terminal V2</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;700&family=Orbitron:wght@400;900&display=swap');
    :root{--muzz-red:#ff0000;--ryachu-gold:#ffcc00;--itsuki-blue:#00d4ff}
    html,body{height:100%;overflow:hidden;margin:0;padding:0}
    body.dark-theme{background:#050505;color:white}
    body.light-theme{background:#f0f2f5;color:#1a1a1a}
    .panel-3d{border-radius:24px;transition:all 0.3s ease;display:flex;flex-direction:column;height:100%}
    .dark-theme .panel-3d{background:#0c0c0c;border:1px solid rgba(255,0,0,0.15);box-shadow:0 10px 30px rgba(0,0,0,0.8)}
    .light-theme .panel-3d{background:#ffffff;border:1px solid #e0e0e0}
    
    /* Burbujas de Chat */
    .bubble-3d{padding:12px 16px;border-radius:20px;font-size:14px;max-width:85%;line-height:1.4;position:relative}
    .bubble-3d.me{background:linear-gradient(145deg,#ff0000,#b30000);color:white;align-self:flex-end;border-bottom-right-radius:4px}
    .dark-theme .bubble-3d.other{background:#1a1a1a;border:1px solid rgba(255,255,255,0.05)}
    
    /* ESTILO MENSAJE PRIVADO - AMARILLO */
    .bubble-3d.private-msg {
      background: var(--ryachu-gold) !important;
      color: #000 !important;
      font-weight: 600;
      border: none;
      box-shadow: 0 4px 15px rgba(255, 204, 0, 0.3);
    }
    
    .ryachu-name{color:var(--ryachu-gold);font-weight:800}
    .itsuki-name{color:var(--itsuki-blue);font-weight:800}
    .hacker-input{font-family:'Fira Code',monospace}
    .dark-theme .hacker-input{color:#39ff14!important}
    .custom-scroll::-webkit-scrollbar{width:4px}
    .custom-scroll::-webkit-scrollbar-thumb{background:var(--muzz-red);border-radius:10px}
    .online-indicator{width:8px;height:8px;background:#39ff14;border-radius:50%;box-shadow:0 0 8px #39ff14}
  </style>
</head>
<body class="dark-theme">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const {useState, useEffect, useRef} = React;
    
    // ConfiguraciÃ³n Firebase (Ofuscada segÃºn tu cÃ³digo)
    const _0xfb={apiKey:atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),authDomain:atob('cHVsc2FyaS5maXJlYmFzZWFwcC5jb20='),databaseURL:atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),projectId:atob('cHVsc2FyaQ=='),storageBucket:atob('cHVsc2FyaS5maXJlYmFzZXN0b3JhZ2UuYXBw'),messagingSenderId:atob('ODI0MzA2MzIxMjMz'),appId:atob('MTo4MjQzMDYzMjEyMzM6d2ViOjJjOWJmYTAyMTcwYTE3ZDU2MGI1NzA=')};
    if(!firebase.apps.length) firebase.initializeApp(_0xfb);
    const _0xdb = firebase.database();
    
    const ADMINS = {
      R: atob('MHgyMDgxNTdiNWVjMzk2NzU5ZTg3NTQwNTgxMDhlY2Y1M2UzMjM5MmZm').toLowerCase(),
      I: atob('MHhmYWI1ODM1Y2ExNGZiM2Y5Zjk3OGM1ZTRkNzMzNzM0ZTYzOTRlMDNm').toLowerCase()
    };

    const _0xem = {"FACES":["ðŸ˜Š","ðŸ˜‚","ðŸ˜‰","ðŸ˜","ðŸ˜˜","ðŸ˜›","ðŸ˜…","ðŸ˜¢","ðŸ˜­","ðŸ˜ ","ðŸ˜ˆ","ðŸ‘½","ðŸ¤–","ðŸ¤¡","ðŸ’€","ðŸ‘»","ðŸ’©"],"HANDS":["ðŸ‘","ðŸ‘Ž","ðŸ‘Œ","âœŒï¸","ðŸ‘","ðŸ‘‹","ðŸ™","ðŸ’ª","â˜ï¸","ðŸ––"],"OBJECTS":["â¤ï¸","â­","ðŸ”¥","ðŸ“š","ðŸ’»","ðŸ“±","ðŸ“·","ðŸ”‘","ðŸ”’","ðŸ’¡","ðŸ’°","ðŸ’Ž"],"NATURE":["â˜€ï¸","â˜ï¸","ðŸŒˆ","ðŸŒ³","ðŸŒ¸","ðŸŒµ","ðŸ±","ðŸ¶","ðŸ¦","ðŸ¦„","ðŸ‰","ðŸ"],"FOOD":["ðŸ•","ðŸ”","ðŸŒ®","ðŸ£","ðŸ°","ðŸ¦","â˜•","ðŸº","ðŸ·","ðŸ¸"],"ACTIVITIES":["âš½","ðŸ€","ðŸŽ¾","ðŸŽµ","ðŸŽ¸","ðŸŽ®","â™Ÿï¸","ðŸŽ¨","ðŸŽ¬"]};
    const _0xch = [{id:"general",name:"GENERAL"},{id:"spanish",name:"ESPAÃ‘OL"},{id:"dao",name:"DAO"}];

    function App() {
      const [_0xb1, _0xb2] = useState(null); // User
      const [_0xb3, _0xb4] = useState([]);   // Messages
      const [_0xb5, _0xb6] = useState([]);   // Online Users
      const [_0xb7, _0xb8] = useState({});   // Muted
      const [_0xb9, _0xc0] = useState("");   // Pinned
      const [_0xc1, _0xc2] = useState("");   // Input
      const [_0xc3, _0xc4] = useState(true); // Dark Mode
      const [_0xc5, _0xc6] = useState(false);// Emoji Window
      const [_0xc7, _0xc8] = useState("FACES");
      const [_0xc9, _0xd0] = useState(_0xch[0]); // Active Channel
      
      // Estados para Mensajes Privados
      const [targetPM, setTargetPM] = useState(null); // Usuario destino PM
      const [_0xd1, _0xd2] = useState(false); // Mobile Sidebar

      const _0xe1 = useRef(null);

      // --- LOGICA DE CIFRADO E3EE ---
      const encryptMsg = (msg, key) => CryptoJS.AES.encrypt(msg, key).toString();
      const decryptMsg = (cipher, key) => {
        try {
          const bytes = CryptoJS.AES.decrypt(cipher, key);
          return bytes.toString(CryptoJS.enc.Utf8);
        } catch(e) { return "[Mensaje Cifrado]"; }
      };

      useEffect(() => {
        const _0xe3 = sessionStorage.getItem('muzz_wallet_address');
        if(!_0xe3) { window.location.href='login.html'; return; }
        
        firebase.auth().signInAnonymously().then((_0xe4) => {
          const _0xe5 = _0xe4.user.uid;
          const _0xe6 = !_0xe3.startsWith('guest_');
          let _0xe7="", _0xe8="user";

          if(_0xe6) {
            const _0xe9 = _0xe3.toLowerCase();
            if(_0xe9 === ADMINS.R){ _0xe7="Ryachu"; _0xe8="ryachu"; }
            else if(_0xe9 === ADMINS.I){ _0xe7="Itsuki"; _0xe8="itsuki"; }
            else { _0xe7=`Node_${_0xe3.slice(-4)}`; }
          } else {
            _0xe7 = _0xe3.replace('guest_',''); _0xe8="guest";
          }

          const userData = {username:_0xe7, uid:_0xe5, role:_0xe8, isWallet:_0xe6, walletAddr: _0xe3};
          _0xb2(userData);

          _0xdb.ref(`status/${_0xe5}`).onDisconnect().remove();
          _0xdb.ref(`status/${_0xe5}`).set({username:_0xe7, role:_0xe8, uid:_0xe5, isWallet:_0xe6});
          
          _0xdb.ref('status').on('value', snap => _0xb6(snap.val() ? Object.values(snap.val()) : []));
          _0xdb.ref('settings/pinned').on('value', snap => _0xc0(snap.val() || ""));
          _0xdb.ref('muted').on('value', snap => _0xb8(snap.val() || {}));
        });
      }, []);

      // Carga de Mensajes (PÃºblicos o Privados)
      useEffect(() => {
        if(!_0xb1) return;
        
        let path = 'messages/' + _0xc9.id;
        if(targetPM) {
          // Crear un ID de sala Ãºnico basado en ambos UIDs ordenados alfabÃ©ticamente
          const roomID = [_0xb1.uid, targetPM.uid].sort().join('_');
          path = 'pms/' + roomID;
        }

        const _0xf3 = _0xdb.ref(path).limitToLast(50);
        _0xf3.on('value', snap => {
          const val = snap.val();
          if(val) {
            const list = Object.keys(val).map(k => ({id:k, ...val[k]}));
            
            // LÃ³gica de Borrado 24h para PMs
            if(targetPM) {
              const now = Date.now();
              list.forEach(m => {
                if(now - m.timestamp > 86400000) { // 24 horas
                  _0xdb.ref(`${path}/${m.id}`).remove();
                }
              });
            }
            _0xb4(list);
          } else {
            _0xb4([]);
          }
        });
        return () => _0xf3.off();
      }, [_0xc9, _0xb1, targetPM]);

      useEffect(() => { _0xe1.current?.scrollIntoView({behavior:'smooth'}); }, [_0xb3]);

      const handleSend = () => {
        if(!_0xc1.trim()) return;
        if(_0xb7[_0xb1.uid] && _0xb7[_0xb1.uid] > Date.now()) {
          alert("EstÃ¡s silenciado"); return;
        }

        let msgData = {
          username: _0xb1.username,
          role: _0xb1.role,
          userId: _0xb1.uid,
          timestamp: Date.now(),
          type: targetPM ? 'private' : 'public'
        };

        if(targetPM) {
          // La llave de cifrado es el roomID
          const roomID = [_0xb1.uid, targetPM.uid].sort().join('_');
          msgData.content = encryptMsg(_0xc1, roomID);
          _0xdb.ref('pms/' + roomID).push(msgData);
        } else {
          msgData.content = _0xc1;
          _0xdb.ref('messages/' + _0xc9.id).push(msgData);
        }

        _0xc2(""); _0xc6(false);
      };

      if(!_0xb1) return <div className="h-full flex items-center justify-center text-red-600 font-orbitron animate-pulse">CONNECTING_SECURE_TERMINAL...</div>;

      return (
        <div className="flex h-screen p-2 md:p-6 gap-6 max-w-[1600px] mx-auto overflow-hidden">
          
          {/* SIDEBAR */}
          <aside className={`fixed lg:relative z-50 inset-y-0 left-0 w-72 lg:w-64 transition-all duration-300 transform panel-3d p-6 flex flex-col ${_0xd1?'translate-x-0':'-translate-x-full lg:translate-x-0 shadow-2xl'}`}>
            <div className="mb-8 flex items-center gap-3">
              <div className="w-10 h-10 bg-red-600 rounded-xl flex items-center justify-center shadow-lg"><i className="fas fa-shield-halved text-white"></i></div>
              <h1 className="font-orbitron font-black text-xl italic tracking-tighter">MUZZ<span className="text-red-600">SNAP</span></h1>
            </div>

            <div className="flex-1 overflow-y-auto custom-scroll space-y-8 pr-2">
              {/* Canales */}
              <div>
                <p className="text-[10px] text-gray-500 font-bold tracking-[0.3em] mb-4 uppercase">Channels</p>
                {_0xch.map(c => (
                  <button key={c.id} onClick={()=>{_0xd0(c); setTargetPM(null); _0xd2(false);}} className={`w-full text-left px-4 py-3 rounded-xl text-xs font-bold mb-1 transition-all ${!targetPM && _0xc9.id===c.id ? 'bg-red-600/10 text-red-600 border-l-2 border-red-600' : 'text-gray-500 hover:text-white'}`}>
                    # {c.name}
                  </button>
                ))}
              </div>

              {/* Mensajes Privados (Solo Wallets) */}
              <div>
                <p className="text-[10px] text-gray-500 font-bold tracking-[0.3em] mb-4 uppercase">E3EE Nodes (Wallet Only)</p>
                <div className="space-y-2">
                  {_0xb5.filter(u => u.isWallet && u.uid !== _0xb1.uid).map((u, i) => (
                    <button key={i} onClick={() => {setTargetPM(u); _0xd2(false);}} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all ${targetPM?.uid === u.uid ? 'bg-yellow-500/10 border border-yellow-500/30' : 'hover:bg-white/5'}`}>
                      <span className="online-indicator"></span>
                      <span className={`text-[11px] truncate font-bold uppercase ${u.role==='ryachu'?'ryachu-name':u.role==='itsuki'?'itsuki-name':'text-gray-400'}`}>
                        {u.username}
                      </span>
                      <i className="fa-brands fa-ethereum text-[10px] text-red-600 ml-auto"></i>
                    </button>
                  ))}
                  {_0xb5.filter(u => u.isWallet).length <= 1 && <p className="text-[9px] text-gray-700 italic">No otros nodos wallet activos...</p>}
                </div>
              </div>
            </div>
            
            <button onClick={()=>{sessionStorage.clear(); window.location.href='login.html'}} className="mt-6 w-full py-3 text-[10px] border border-red-900/30 text-red-600 rounded-xl uppercase font-black hover:bg-red-600/5 transition-all">
              <i className="fas fa-power-off mr-2"></i>Logout
            </button>
          </aside>

          {/* MAIN CHAT */}
          <main className="flex-1 panel-3d flex flex-col overflow-hidden border border-white/5 h-full relative">
            
            {/* Pinned Msg */}
            {_0xb9 && <div className="bg-red-600/10 border-b border-red-600/30 py-2 px-6"><marquee className="text-[10px] font-bold text-red-500 uppercase tracking-widest">{_0xb9}</marquee></div>}

            {/* Header */}
            <header className="h-16 flex items-center justify-between px-8 bg-white/5 border-b border-white/5 flex-shrink-0">
              <div className="flex items-center gap-4">
                <button onClick={()=>_0xd2(true)} className="lg:hidden text-red-600"><i className="fas fa-bars"></i></button>
                <h2 className="text-sm font-black tracking-[0.2em] text-red-600 uppercase italic">
                  {targetPM ? `// PRIVATE_LINK: ${targetPM.username}` : `/ ${_0xc9.name}`}
                </h2>
                {targetPM && <span className="text-[9px] bg-yellow-500/20 text-yellow-500 px-2 py-0.5 rounded border border-yellow-500/30 font-bold animate-pulse">E3EE ACTIVE</span>}
              </div>
              <button onClick={() => {_0xc4(!_0xc3); document.body.className=_0xc3?'light-theme':'dark-theme'}} className="w-10 h-10 rounded-xl border border-red-600/20 flex items-center justify-center">
                <i className={`fas ${_0xc3?'fa-sun text-yellow-500':'fa-moon text-blue-500'}`}></i>
              </button>
            </header>

            {/* Messages Area */}
            <div className="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col gap-5 custom-scroll">
              {_0xb3.map((m, i) => {
                const isMe = m.userId === _0xb1.uid;
                const isPrivate = m.type === 'private';
                let displayContent = m.content;

                if(isPrivate) {
                  const roomID = [_0xb1.uid, (isMe ? targetPM?.uid : m.userId)].sort().join('_');
                  displayContent = decryptMsg(m.content, roomID);
                }

                return (
                  <div key={m.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                    <span 
                      onClick={() => {
                        const clickedUser = _0xb5.find(u => u.uid === m.userId);
                        if(clickedUser?.isWallet && clickedUser.uid !== _0xb1.uid) setTargetPM(clickedUser);
                      }}
                      className={`text-[10px] font-black mb-1.5 uppercase px-2 cursor-pointer hover:underline ${m.role==='ryachu'?'ryachu-name':m.role==='itsuki'?'itsuki-name':'text-gray-500'}`}
                    >
                      {m.role==='ryachu'&&'ðŸ‘‘ '}{m.role==='itsuki'&&'ðŸ’Ž '}{m.username} {isPrivate && 'ðŸ”’'}
                    </span>
                    <div className={`bubble-3d shadow-xl ${isMe ? 'me' : 'other'} ${isPrivate ? 'private-msg' : ''}`}>
                      {displayContent}
                    </div>
                  </div>
                )
              })}
              <div ref={_0xe1}></div>
            </div>

            {/* Input Area */}
            <div className={`p-4 md:p-6 ${_0xc3?'bg-black/40':'bg-gray-50'} border-t border-white/5`}>
              <div className="flex items-center bg-black/30 border border-white/10 rounded-2xl p-2.5 pl-5 focus-within:border-red-600/50 shadow-inner">
                <button onClick={()=>_0xc6(!_0xc5)} className="text-gray-500 hover:text-red-600 transition-colors mr-3"><i className="far fa-laugh-beam text-xl"></i></button>
                <input 
                  value={_0xc1} 
                  onChange={e=>_0xc2(e.target.value)} 
                  onKeyDown={e=>e.key==='Enter'&&handleSend()}
                  placeholder={targetPM ? "Send encrypted private message..." : "Broadcast to channel..."} 
                  className="flex-1 bg-transparent border-none focus:ring-0 text-sm hacker-input"
                />
                <button onClick={handleSend} className="w-12 h-12 bg-red-600 rounded-xl flex items-center justify-center hover:bg-red-500 active:scale-95 transition-all shadow-lg shadow-red-600/20">
                  <i className="fas fa-paper-plane text-white"></i>
                </button>
              </div>
            </div>
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
