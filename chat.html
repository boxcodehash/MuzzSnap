<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Complete Edition</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;900&display=swap');
    :root{--muzz-red:#ff0000;--ryachu-gold:#ffcc00;--itsuki-blue:#00d4ff}
    html,body{height:100%;overflow:hidden;margin:0;padding:0;touch-action:manipulation;background:#050505;color:white}
    .panel-3d{border-radius:24px;transition:all 0.3s ease;display:flex;flex-direction:column;height:100%;background:#0c0c0c;border:1px solid rgba(255,0,0,0.15);box-shadow:0 10px 30px rgba(0,0,0,0.8)}
    .bubble-3d{padding:12px 16px;border-radius:20px;font-size:14px;max-width:85%;line-height:1.4}
    .bubble-3d.me{background:linear-gradient(145deg,#ff0000,#b30000);color:white;align-self:flex-end;border-bottom-right-radius:4px}
    .bubble-3d.other{background:#1a1a1a;border:1px solid rgba(255,255,255,0.05)}
    .emoji-window{max-height:180px;overflow-y:auto;display:grid;grid-template-columns:repeat(7,1fr);gap:10px;padding:15px}
    .emoji-btn{font-size:1.5rem;cursor:pointer;display:flex;justify-content:center}
    .custom-scroll::-webkit-scrollbar{width:4px}
    .custom-scroll::-webkit-scrollbar-thumb{background:var(--muzz-red);border-radius:10px}
    .hacker-input{font-family:'Fira Code',monospace;color:#39ff14!important}
    .online-indicator{width:8px;height:8px;background:#39ff14;border-radius:50%;box-shadow:0 0 8px #39ff14}
    .ryachu-name{color:var(--ryachu-gold);font-weight:800}.itsuki-name{color:var(--itsuki-blue);font-weight:800}
  </style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const {useState, useEffect, useRef} = React;

    const fbConfig = {
      apiKey: atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),
      authDomain: atob('cHVsc2FyaS5maXJlYmFzZWFwcC5jb20='),
      databaseURL: atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),
      projectId: atob('cHVsc2FyaQ=='),
      appId: atob('MTo4MjQzMDYzMjEyMzM6d2ViOjJjOWJmYTAyMTcwYTE3ZDU2MGI1NzA=')
    };

    if (!firebase.apps.length) firebase.initializeApp(fbConfig);
    const db = firebase.database();

    const _0xem = {
      "FACES": ["ðŸ˜Š","ðŸ˜‚","ðŸ˜‰","ðŸ˜","ðŸ˜˜","ðŸ˜›","ðŸ˜…","ðŸ˜¢","ðŸ˜­","ðŸ˜ ","ðŸ˜ˆ","ðŸ‘½","ðŸ¤–","ðŸ¤¡","ðŸ’€","ðŸ‘»","ðŸ’©"],
      "HANDS": ["ðŸ‘","ðŸ‘Ž","ðŸ‘Œ","âœŒï¸","ðŸ‘","ðŸ‘‹","ðŸ™","ðŸ’ª","â˜ï¸","ðŸ––"],
      "OBJECTS": ["â¤ï¸","â­","ðŸ”¥","ðŸ“š","ðŸ’»","ðŸ“±","ðŸ“·","ðŸ”‘","ðŸ”’","ðŸ’¡","ðŸ’°","ðŸ’Ž"]
    };

    const channels = [
      { id: "general", name: "GENERAL" },
      { id: "spanish", name: "ESPAÃ‘OL" },
      { id: "dao", name: "DAO" }
    ];

    const admins = {
      R: atob('MHgyMDgxNTdiNWVjMzk2NzU5ZTg3NTQwNTgxMDhlY2Y1M2UzMjM5MmZm').toLowerCase(),
      I: atob('MHhmYWI1ODM1Y2ExNGZiM2Y5Zjk3OGM1ZTRkNzMzNzM0ZTYzOTRlMDNm').toLowerCase()
    };

    function App() {
      const [user, setUser] = useState(null);
      const [messages, setMessages] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [input, setInput] = useState("");
      const [activeChan, setActiveChan] = useState(channels[0]);
      const [targetUser, setTargetUser] = useState(null);
      const [showEmoji, setShowEmoji] = useState(false);
      const [emojiCat, setEmojiCat] = useState("FACES");
      const [sideBar, setSideBar] = useState(false);
      
      const [authStep, setAuthStep] = useState("loading");
      const [regName, setRegName] = useState("");
      const [regPin, setRegPin] = useState("");
      const [errorMsg, setErrorMsg] = useState("");

      const scrollRef = useRef(null);

      useEffect(() => {
        const wallet = sessionStorage.getItem('muzz_wallet_address');
        firebase.auth().signInAnonymously().then(async (cred) => {
          const uid = cred.user.uid;
          if (wallet && !wallet.startsWith('guest_')) {
            const lowAddr = wallet.toLowerCase();
            let name = `Node_${wallet.slice(-4)}`, role = "user";
            if (lowAddr === admins.R) { name = "Ryachu"; role = "ryachu"; }
            else if (lowAddr === admins.I) { name = "Itsuki"; role = "itsuki"; }
            completeLogin({ username: name, uid: uid, role: role, type: 'wallet' });
          } else {
            setAuthStep("auth_screen");
          }
        });
      }, []);

      const completeLogin = (userData) => {
        setUser(userData);
        setAuthStep("chat");
        db.ref(`status/${userData.uid}`).onDisconnect().remove();
        db.ref(`status/${userData.uid}`).set(userData);
        db.ref('status').on('value', s => setOnlineUsers(s.val() ? Object.values(s.val()) : []));
      };

      const handleAuth = async () => {
        setErrorMsg("");
        const nameKey = regName.trim().toLowerCase();
        if (nameKey.length < 3) { setErrorMsg("NAME TOO SHORT"); return; }
        if (regPin.length !== 4) { setErrorMsg("PIN MUST BE 4 CHARACTERS"); return; }

        const userRef = db.ref(`accounts/${nameKey}`);
        const snap = await userRef.once('value');

        if (snap.exists()) {
          const existing = snap.val();
          if (existing.pin === regPin) completeLogin(existing);
          else setErrorMsg("USERNAME NOT AVAILABLE");
        } else {
          const uid = firebase.auth().currentUser.uid;
          const newUserData = { username: regName.trim(), pin: regPin, uid: uid, role: 'user', type: 'manual' };
          await userRef.set(newUserData);
          completeLogin(newUserData);
        }
      };

      const getSecretKey = (pId) => [user.uid, pId].sort().join('_muzz_');
      const encrypt = (t, pId) => CryptoJS.AES.encrypt(t, getSecretKey(pId)).toString();
      const decrypt = (c, pId) => {
        try {
          const b = CryptoJS.AES.decrypt(c, getSecretKey(pId));
          return b.toString(CryptoJS.enc.Utf8) || "ðŸ”’ Encrypted";
        } catch(e) { return "âŒ Error"; }
      };

      useEffect(() => {
        if (authStep !== "chat") return;
        const path = targetUser ? `pms/${[user.uid, targetUser.uid].sort().join('_')}` : `messages/${activeChan.id}`;
        const mRef = db.ref(path).limitToLast(40);
        mRef.on('value', s => {
          const d = s.val();
          setMessages(d ? Object.keys(d).map(k => ({id:k, ...d[k]})) : []);
        });
        return () => mRef.off();
      }, [authStep, targetUser, activeChan]);

      useEffect(() => { scrollRef.current?.scrollIntoView({behavior:'smooth'}); }, [messages]);

      const send = () => {
        if (!input.trim()) return;
        const path = targetUser ? `pms/${[user.uid, targetUser.uid].sort().join('_')}` : `messages/${activeChan.id}`;
        db.ref(path).push({
          content: targetUser ? encrypt(input, targetUser.uid) : input,
          username: user.username,
          userId: user.uid,
          role: user.role,
          timestamp: Date.now(),
          encrypted: !!targetUser
        });
        setInput("");
        setShowEmoji(false);
      };

      if (authStep === "auth_screen") {
        return (
          <div className="h-full flex items-center justify-center p-6 bg-black">
            <div className="panel-3d p-8 w-full max-w-md text-center">
              <h2 className="font-orbitron text-red-600 text-2xl mb-8 italic uppercase">Identity Check</h2>
              <div className="space-y-4 text-left">
                <div>
                  <label className="text-[10px] text-red-500 font-bold ml-2">USER_ID</label>
                  <input value={regName} onChange={e => setRegName(e.target.value.replace(/[^a-zA-Z0-9]/g,""))} placeholder="Satoshi" className="w-full bg-black border border-white/10 p-4 rounded-xl hacker-input focus:border-red-600 outline-none" />
                </div>
                <div>
                  <label className="text-[10px] text-red-500 font-bold ml-2">4-CHAR PIN</label>
                  <input maxLength="4" value={regPin} onChange={e => setRegPin(e.target.value)} placeholder="A1B2" className="w-full bg-black border border-white/10 p-4 rounded-xl hacker-input focus:border-red-600 outline-none text-center tracking-[1em]" />
                </div>
                {errorMsg && <p className="text-red-500 text-xs font-bold animate-pulse text-center">{errorMsg}</p>}
                <button onClick={handleAuth} className="w-full bg-red-600 py-4 rounded-xl text-white font-black font-orbitron mt-4">ACCESS</button>
              </div>
            </div>
          </div>
        );
      }

      if (authStep === "chat") {
        return (
          <div className="flex h-full p-0 md:p-4 lg:p-6 gap-0 md:gap-6 max-w-[1600px] mx-auto overflow-hidden">
            <aside className={`fixed lg:relative z-50 inset-y-0 left-0 w-72 transition-all duration-300 transform panel-3d p-6 flex flex-col ${sideBar ? 'translate-x-0' : '-translate-x-full lg:translate-x-0 shadow-2xl'}`}>
              <div className="mb-8 flex items-center justify-between">
                <h1 className="font-orbitron font-black text-xl italic tracking-tighter">MUZZ<span className="text-red-600">SNAP</span></h1>
                <button onClick={() => setSideBar(false)} className="lg:hidden text-gray-500"><i className="fas fa-times"></i></button>
              </div>
              <div className="flex-1 overflow-y-auto custom-scroll space-y-6">
                <div>
                  <p className="text-[10px] text-gray-500 font-bold mb-4 uppercase">Channels</p>
                  {channels.map(c => (
                    <button key={c.id} onClick={() => { setActiveChan(c); setTargetUser(null); setSideBar(false); }} className={`w-full text-left px-4 py-3 rounded-xl text-xs font-bold mb-1 ${(!targetUser && activeChan.id === c.id) ? 'bg-red-600/10 text-red-600 border-l-2 border-red-600' : 'text-gray-500'}`}># {c.name}</button>
                  ))}
                </div>
                <div>
                  <p className="text-[10px] text-gray-500 font-bold mb-4 uppercase">Direct Messages</p>
                  {onlineUsers.filter(u => u.uid !== user.uid).map(u => (
                    <div key={u.uid} onClick={() => { setTargetUser(u); setSideBar(false); }} className={`flex items-center gap-3 px-3 py-2 rounded-xl cursor-pointer mb-1 ${targetUser?.uid === u.uid ? 'bg-red-600/20' : 'hover:bg-white/5'}`}>
                      <span className="online-indicator"></span>
                      <span className={`text-[11px] font-bold uppercase flex-1 ${u.role==='ryachu'?'ryachu-name':u.role==='itsuki'?'itsuki-name':'text-gray-400'}`}>{u.username}</span>
                    </div>
                  ))}
                </div>
              </div>
              <button onClick={() => {sessionStorage.clear(); window.location.reload();}} className="mt-4 py-3 text-[10px] border border-red-900/30 text-red-600 rounded-xl font-black uppercase">Logout</button>
            </aside>

            <main className="flex-1 panel-3d flex flex-col overflow-hidden relative rounded-none md:rounded-[24px]">
              <header className="h-16 flex items-center justify-between px-6 bg-white/5 border-b border-white/5">
                <div className="flex items-center gap-4">
                  <button onClick={() => setSideBar(true)} className="lg:hidden text-red-600 text-xl"><i className="fas fa-bars"></i></button>
                  <h2 className="text-sm font-black text-red-600 uppercase italic">{targetUser ? `ðŸ”’ DM: ${targetUser.username}` : `/ ${activeChan.name}`}</h2>
                </div>
                {targetUser && <button onClick={() => setTargetUser(null)} className="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Back</button>}
              </header>

              <div className="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col gap-4 custom-scroll">
                {messages.map(m => (
                  <div key={m.id} className={`flex flex-col ${m.userId === user.uid ? 'items-end' : 'items-start'}`}>
                    <span className={`text-[9px] mb-1 px-2 uppercase font-bold ${m.role==='ryachu'?'ryachu-name':m.role==='itsuki'?'itsuki-name':'text-gray-600'}`}>{m.username} {m.encrypted && "ðŸ”’"}</span>
                    <div className={`bubble-3d shadow-xl ${m.userId === user.uid ? 'me' : 'other'}`}>
                      {m.encrypted ? decrypt(m.content, (m.userId === user.uid ? targetUser?.uid : m.userId)) : m.content}
                    </div>
                  </div>
                ))}
                <div ref={scrollRef}></div>
              </div>

              <div className="p-4 bg-black/40 border-t border-white/5">
                {showEmoji && (
                  <div className="mb-4 panel-3d border border-red-600/20 bg-black/95">
                    <div className="flex border-b border-white/5">
                      {Object.keys(_0xem).map(cat => (
                        <button key={cat} onClick={() => setEmojiCat(cat)} className={`px-4 py-2 text-[9px] font-bold ${emojiCat===cat?'text-red-600':'text-gray-500'}`}>{cat}</button>
                      ))}
                    </div>
                    <div className="emoji-window custom-scroll">
                      {_0xem[emojiCat].map(e => <span key={e} onClick={() => setInput(input+e)} className="emoji-btn">{e}</span>)}
                    </div>
                  </div>
                )}
                <div className="flex items-center bg-black/30 border border-white/10 rounded-2xl p-2 pl-4">
                  <button onClick={() => setShowEmoji(!showEmoji)} className="text-gray-500 mr-3 text-xl"><i className="far fa-smile"></i></button>
                  <input value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && send()} placeholder="Transmit message..." className="flex-1 bg-transparent border-none focus:ring-0 text-sm hacker-input px-2" />
                  <button onClick={send} className="w-12 h-12 bg-red-600 rounded-xl flex items-center justify-center shadow-lg"><i className="fas fa-paper-plane text-white"></i></button>
                </div>
              </div>
            </main>
            {sideBar && <div onClick={() => setSideBar(false)} className="fixed inset-0 bg-black/80 z-40 lg:hidden"></div>}
          </div>
        );
      }
      return null;
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
