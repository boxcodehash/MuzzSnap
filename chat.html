<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Admin & Themes</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');
    
    :root {
      --bg-panel: rgba(20, 0, 0, 0.8);
      --accent: #ff0000;
      --text-main: #ffffff;
      --border: rgba(255, 0, 0, 0.3);
    }

    body.theme-light {
      --bg-panel: rgba(255, 255, 255, 0.95);
      --accent: #2563eb;
      --text-main: #1f2937;
      --border: rgba(0, 0, 0, 0.1);
      background: #f3f4f6;
    }

    body.theme-dark {
      --bg-panel: rgba(15, 23, 42, 0.95);
      --accent: #10b981;
      --text-main: #f8fafc;
      --border: rgba(255, 255, 255, 0.1);
      background: #020617;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Rajdhani', sans-serif; transition: background 0.3s ease; height: 100vh; overflow: hidden; color: var(--text-main); }
    
    .cyber-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, rgba(139,0,0,0.2) 0%, #000 100%); z-index: -1; }
    body.theme-light .cyber-bg, body.theme-dark .cyber-bg { display: none; }

    .sidebar, .chat-container { 
      background: var(--bg-panel) !important; 
      border: 2px solid var(--border) !important;
      backdrop-filter: blur(10px);
    }

    .message-bubble.other { background: var(--border); color: var(--text-main); }
    .message-bubble.me { background: var(--accent); color: #fff; }

    .admin-glow { box-shadow: 0 0 15px var(--accent); border-color: var(--accent) !important; }
    
    /* ReutilizaciÃ³n de clases anteriores para mantener el look */
    .container-main { display: flex; height: 100vh; padding: 20px; gap: 20px; }
    @media (max-width: 768px) { .container-main { padding: 10px; gap: 10px; } }
  </style>
</head>
<body>
  <div class="cyber-bg"></div>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari",
      storageBucket: "pulsari.firebasestorage.app",
      messagingSenderId: "824306321233",
      appId: "1:824306321233:web:2c9bfa02170a17d560b570"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const ADMIN_WALLETS = {
      "2a3f1f37c160f0b170f5cf95b53f4228e23994b76c3d016494dfc289fa1d00f0": "Ryachu",
      "819c961c022883f3e18a8008e43e26458519e48c1e4c70308009696987c8801d": "Itsuki"
    };

    function App() {
      const [user, setUser] = useState(null);
      const [chan, setChan] = useState("general");
      const [messages, setMessages] = useState([]);
      const [users, setUsers] = useState([]);
      const [text, setText] = useState("");
      const [theme, setTheme] = useState(localStorage.getItem('theme') || 'muzzle');
      const [showAdminPanel, setShowAdminPanel] = useState(false);
      const [alertMsg, setAlertMsg] = useState(null);
      
      const scrollRef = useRef();

      useEffect(() => {
        document.body.className = theme === 'muzzle' ? '' : `theme-${theme}`;
        localStorage.setItem('theme', theme);
      }, [theme]);

      const hashWallet = async (address) => {
        const msgUint8 = new TextEncoder().encode(address.toLowerCase());
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
      };

      const login = async () => {
        if (!window.ethereum) return alert("Instala MetaMask");
        try {
          const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const wallet = accs[0].toLowerCase();
          const hashed = await hashWallet(wallet);
          const cred = await auth.signInAnonymously();
          
          const isGod = ADMIN_WALLETS.hasOwnProperty(hashed);
          const userData = {
            uid: cred.user.uid,
            name: ADMIN_WALLETS[hashed] || `Node_${wallet.slice(-4)}`,
            isGod,
            wallet
          };
          await db.ref(`presence/${cred.user.uid}`).set(userData);
          db.ref(`presence/${cred.user.uid}`).onDisconnect().remove();
          setUser(userData);
        } catch (e) { console.error(e); }
      };

      useEffect(() => {
        if (!user) return;
        const mRef = db.ref(`messages/${chan}`).limitToLast(50);
        mRef.on('value', s => {
          const val = s.val();
          setMessages(val ? Object.keys(val).map(k => ({id:k, ...val[k]})) : []);
        });
        db.ref('presence').on('value', s => setUsers(s.val() ? Object.values(s.val()) : []));
        db.ref('system_alert').on('value', s => setAlertMsg(s.val()));
        return () => { mRef.off(); db.ref('presence').off(); db.ref('system_alert').off(); };
      }, [user, chan]);

      const handleSend = async () => {
        if (!text.trim()) return;
        
        // Comandos de Administrador
        if (user.isGod) {
          if (text === '/clear') { await db.ref(`messages/${chan}`).remove(); setText(""); return; }
          if (text.startsWith('/alert ')) { await db.ref('system_alert').set(text.replace('/alert ', '')); setText(""); return; }
          if (text === '/clearalert') { await db.ref('system_alert').remove(); setText(""); return; }
        }

        await db.ref(`messages/${chan}`).push({
          content: text,
          name: user.name,
          uid: user.uid,
          isGod: user.isGod,
          time: Date.now()
        });
        setText("");
      };

      if (!user) return (
        <div className="flex h-screen items-center justify-center bg-black">
          <button onClick={login} className="p-6 border-2 border-red-600 text-red-600 font-bold hover:bg-red-600 hover:text-white transition">INICIAR SESIÃ“N NEURAL</button>
        </div>
      );

      return (
        <div className="container-main">
          <aside className="sidebar w-80 rounded-2xl p-6 flex flex-col">
            <h1 className="text-2xl font-black mb-6 tracking-widest text-center" style={{color: 'var(--accent)'}}>MUZZSNAP</h1>
            
            <div className="mb-6">
              <p className="text-[10px] opacity-50 uppercase mb-2">TemÃ¡tica</p>
              <div className="grid grid-cols-3 gap-1">
                {['light', 'dark', 'muzzle'].map(t => (
                  <button key={t} onClick={() => setTheme(t)} className={`text-[9px] p-2 border ${theme === t ? 'border-red-500 bg-red-500/10' : 'border-white/10'}`}>{t.toUpperCase()}</button>
                ))}
              </div>
            </div>

            <div className="flex-1 overflow-y-auto">
              <p className="text-[10px] opacity-50 uppercase mb-2">Sectores</p>
              {['general', 'espaÃ±ol', 'devs'].map(c => (
                <button key={c} onClick={() => setChan(c)} className={`w-full text-left p-3 mb-1 rounded ${chan === c ? 'bg-red-500/20 text-red-500 font-bold' : ''}`}># {c}</button>
              ))}
              
              <p className="text-[10px] opacity-50 uppercase mt-6 mb-2">Online ({users.length})</p>
              {users.map((u, i) => (
                <div key={i} className="text-sm py-1 flex items-center gap-2">
                   <div className={`w-1.5 h-1.5 rounded-full ${u.isGod ? 'bg-yellow-400' : 'bg-green-500'}`}></div>
                   <span className={u.isGod ? 'text-yellow-400 font-bold' : ''}>{u.name}</span>
                </div>
              ))}
            </div>

            {user.isGod && (
              <button onClick={() => setShowAdminPanel(true)} className="mt-4 p-3 bg-yellow-500/10 border border-yellow-500 text-yellow-500 text-xs font-bold rounded-lg hover:bg-yellow-500 hover:text-black transition">
                <i className="fas fa-shield-alt mr-2"></i> CONSOLA ADMIN
              </button>
            )}
          </aside>

          <main className="chat-container flex-1 rounded-2xl flex flex-col relative overflow-hidden">
            {alertMsg && <div className="bg-red-600 text-white p-2 text-center text-xs font-bold animate-pulse">SISTEMA: {alertMsg}</div>}
            
            <div className="p-4 border-b border-white/10 flex justify-between">
              <span className="font-bold opacity-70 uppercase tracking-tighter">Sector: {chan}</span>
              {user.isGod && <span className="text-yellow-400 text-xs font-black">GOD_MODE_ACTIVE</span>}
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              {messages.map(m => (
                <div key={m.id} className={`flex flex-col ${m.uid === user.uid ? 'items-end' : 'items-start'}`}>
                  <span className={`text-[10px] ${m.isGod ? 'text-yellow-400' : 'opacity-40'}`}>{m.name} {m.isGod && 'ðŸ‘‘'}</span>
                  <div className={`message-bubble max-w-[70%] p-3 rounded-xl text-sm ${m.uid === user.uid ? 'me shadow-lg' : 'other'}`}>
                    {m.content}
                  </div>
                </div>
              ))}
              <div ref={scrollRef}></div>
            </div>

            <div className="p-4 bg-black/20 border-t border-white/10">
              <div className="flex gap-2">
                <input 
                  value={text} 
                  onChange={e => setText(e.target.value)} 
                  onKeyDown={e => e.key === 'Enter' && handleSend()}
                  placeholder={user.isGod ? "Escribe comando o mensaje..." : "Escribe un mensaje..."}
                  className="flex-1 bg-transparent border border-white/10 rounded-xl p-3 outline-none focus:border-red-500"
                />
                <button onClick={handleSend} className="bg-red-600 text-white w-12 h-12 rounded-xl"><i className="fas fa-bolt"></i></button>
              </div>
            </div>
          </main>

          {showAdminPanel && (
            <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[1000] p-4" onClick={() => setShowAdminPanel(false)}>
              <div className="bg-[#1a1a1a] border-2 border-yellow-500 p-8 rounded-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
                <h2 className="text-yellow-500 font-black text-xl mb-4 tracking-tighter">COMANDOS DE NIVEL DIOS</h2>
                <div className="space-y-4 text-sm text-white/70">
                  <div className="bg-black/40 p-3 rounded">
                    <p className="text-yellow-400 font-bold">/clear</p>
                    <p className="text-[11px]">Borra todo el historial del canal actual.</p>
                  </div>
                  <div className="bg-black/40 p-3 rounded">
                    <p className="text-yellow-400 font-bold">/alert [mensaje]</p>
                    <p className="text-[11px]">Muestra un mensaje global de emergencia.</p>
                  </div>
                  <div className="bg-black/40 p-3 rounded">
                    <p className="text-yellow-400 font-bold">/clearalert</p>
                    <p className="text-[11px]">Elimina la alerta activa del sistema.</p>
                  </div>
                </div>
                <button onClick={() => setShowAdminPanel(false)} className="w-full mt-6 p-3 bg-yellow-500 text-black font-bold rounded-lg">CERRAR CONSOLA</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
