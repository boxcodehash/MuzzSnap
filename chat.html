<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pulsari Chat</title>
<meta name="viewport" content="width=device-width">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="chat"></div>
<input id="msg"><button onclick="send()">Send</button>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
  databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
  projectId: "pulsari"
});

firebase.auth().onAuthStateChanged(u=>{
  if(!u) location.href="index.html";
});

const db = firebase.database();
db.ref("messages/global").limitToLast(50).on("child_added",s=>{
  const m=s.val();
  chat.innerHTML+=`<div>${m.user.slice(0,6)}: ${m.text}</div>`;
});

async function send(){
  const text=msg.value;
  msg.value="";
  await firebase.functions().httpsCallable("sendMessage")({text});
}
</script>
</body>
</html>
