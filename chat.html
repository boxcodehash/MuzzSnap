<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Terminal index.html</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;900&display=swap');
    :root{--muzz-red:#ff0000;--ryachu-gold:#ffcc00;--itsuki-blue:#00d4ff}
    html,body{height:100%;overflow:hidden;margin:0;padding:0;background:#050505;color:white}
    body.light-theme{background:#f0f2f5;color:#1a1a1a}
    .panel-3d{border-radius:24px;display:flex;flex-direction:column;height:100%;transition:all 0.3s}
    .dark-theme .panel-3d{background:#0c0c0c;border:1px solid rgba(255,0,0,0.15)}
    .light-theme .panel-3d{background:#ffffff;border:1px solid #e0e0e0}
    .bubble-3d{padding:12px 16px;border-radius:20px;font-size:14px;max-width:85%;line-height:1.4;position:relative}
    .bubble-3d.me{background:linear-gradient(145deg,#ff0000,#b30000);color:white;align-self:flex-end}
    .dark-theme .bubble-3d.other{background:#1a1a1a;border:1px solid rgba(255,255,255,0.05)}
    /* Mensajes Privados E3EE - AMARILLO */
    .bubble-3d.private{background:var(--ryachu-gold)!important;color:black!important;font-weight:bold}
    /* Estilos Light Theme */
    .light-theme .bubble-3d.other{background:#000000!important;color:#ffffff!important}
    .light-theme .bubble-3d.me{background:#00d4ff!important;color:white!important}
    .hacker-input{font-family:'Fira Code',monospace}
    .dark-theme .hacker-input{color:#39ff14!important}
    .admin-btn{font-size:10px;padding:8px;border-radius:8px;border:1px solid rgba(255,0,0,0.3);color:#ff0000;font-weight:bold;text-transform:uppercase}
    .custom-scroll::-webkit-scrollbar{width:4px}
    .custom-scroll::-webkit-scrollbar-thumb{background:var(--muzz-red);border-radius:10px}
  </style>
</head>
<body class="dark-theme">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const {useState, useEffect, useRef} = React;

    const fbConf = {
      apiKey: atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),
      authDomain: atob('cHVsc2FyaS5maXJlYmFzZWFwcC5jb20='),
      databaseURL: atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),
      projectId: atob('cHVsc2FyaQ=='),
      appId: atob('MTo4MjQzMDYzMjEyMzM6d2ViOjJjOWJmYTAyMTcwYTE3ZDU2MGI1NzA=')
    };

    if (!firebase.apps.length) firebase.initializeApp(fbConf);
    const db = firebase.database();
    const ADMINS = {
      R: atob('MHgyMDgxNTdiNWVjMzk2NzU5ZTg3NTQwNTgxMDhlY2Y1M2UzMjM5MmZm').toLowerCase(),
      I: atob('MHhmYWI1ODM1Y2ExNGZiM2Y5Zjk3OGM1ZTRkNzMzNzM0ZTYzOTRlMDNm').toLowerCase()
    };

    function App() {
      const [user, setUser] = useState(null);
      const [messages, setMessages] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [activeChan, setActiveChan] = useState({id: "general", name: "GENERAL"});
      const [targetPM, setTargetPM] = useState(null);
      const [input, setInput] = useState("");
      const [isDark, setIsDark] = useState(true);
      const [pinned, setPinned] = useState("");
      const [chatLocked, setChatLocked] = useState(false);
      const [slowMode, setSlowMode] = useState(false);
      const [lastSent, setLastSent] = useState(0);
      const scrollRef = useRef(null);

      // --- LOGICA DE REDIRECCIÓN A LOGIN.HTML ---
      useEffect(() => {
        const wallet = sessionStorage.getItem('muzz_wallet_address');
        if (!wallet) {
          window.location.href = 'index.html'; // Reconoce y redirige si no hay sesión
          return;
        }

        firebase.auth().signInAnonymously().then(cred => {
          let role = "user", name = `Node_${wallet.slice(-4)}`;
          if (wallet.toLowerCase() === ADMINS.R) { role = "ryachu"; name = "Ryachu"; }
          if (wallet.toLowerCase() === ADMINS.I) { role = "itsuki"; name = "Itsuki"; }
          
          const userData = { username: name, uid: cred.user.uid, role, isWallet: true, address: wallet };
          setUser(userData);

          db.ref(`status/${cred.user.uid}`).onDisconnect().remove();
          db.ref(`status/${cred.user.uid}`).set(userData);
          
          db.ref('status').on('value', s => setOnlineUsers(s.val() ? Object.values(s.val()) : []));
          db.ref('settings/locked').on('value', s => setChatLocked(s.val() || false));
          db.ref('settings/slowmode').on('value', s => setSlowMode(s.val() || false));
          db.ref('settings/pinned').on('value', s => setPinned(s.val() || ""));
        });
      }, []);

      // Sincronización de Mensajes y E3EE
      useEffect(() => {
        if (!user) return;
        const path = targetPM ? `pms/${[user.uid, targetPM.uid].sort().join('_')}` : `messages/${activeChan.id}`;
        const ref = db.ref(path).limitToLast(50);
        
        ref.on('value', snap => {
          const data = snap.val();
          if (data) {
            const list = Object.keys(data).map(k => {
              const m = data[k];
              // Borrado automático 24h para privados
              if(targetPM && (Date.now() - m.timestamp > 86400000)) {
                db.ref(`${path}/${k}`).remove();
                return null;
              }
              return {id: k, ...m};
            }).filter(m => m !== null);
            setMessages(list);
          } else setMessages([]);
        });
        return () => ref.off();
      }, [activeChan, targetPM, user]);

      useEffect(() => { scrollRef.current?.scrollIntoView({behavior: 'smooth'}); }, [messages]);

      const sendMessage = () => {
        if (!input.trim()) return;
        const isAdmin = user.role === 'ryachu' || user.role === 'itsuki';
        
        if (!isAdmin) {
          if (chatLocked) return alert("CHAT BLOQUEADO POR ADMIN");
          if (slowMode && (Date.now() - lastSent < 2000)) return alert("ESPERA 2 SEGUNDOS (SLOW MODE)");
        }

        const isPrivate = !!targetPM;
        const path = isPrivate ? `pms/${[user.uid, targetPM.uid].sort().join('_')}` : `messages/${activeChan.id}`;
        const key = isPrivate ? [user.uid, targetPM.uid].sort().join('_') : 'public';

        db.ref(path).push({
          content: isPrivate ? CryptoJS.AES.encrypt(input, key).toString() : input,
          username: user.username,
          userId: user.uid,
          role: user.role,
          timestamp: Date.now(),
          type: isPrivate ? 'private' : 'public',
          receiverId: isPrivate ? targetPM.uid : null
        });
        setInput("");
        setLastSent(Date.now());
      };

      if (!user) return <div className="h-full bg-black flex items-center justify-center font-orbitron text-red-600 animate-pulse">RECONOCIENDO_SESION...</div>;

      return (
        <div className="flex h-screen p-2 md:p-6 gap-6 max-w-[1600px] mx-auto overflow-hidden">
          {/* SIDEBAR */}
          <aside className="hidden lg:flex w-64 panel-3d p-6 flex flex-col">
            <h1 className="font-orbitron font-black text-xl text-red-600 mb-8 italic">MUZZSNAP</h1>
            <div className="flex-1 overflow-y-auto custom-scroll space-y-6">
              {(user.role==='ryachu'||user.role==='itsuki') && (
                <div className="p-3 bg-red-600/5 border border-red-600/20 rounded-xl space-y-2">
                  <button onClick={()=>db.ref('settings/locked').set(!chatLocked)} className="w-full admin-btn">Lock Chat</button>
                  <button onClick={()=>db.ref('settings/slowmode').set(!slowMode)} className="w-full admin-btn">Slow Mode</button>
                </div>
              )}
              <p className="text-[10px] text-gray-500 font-bold uppercase">Canales</p>
              {['GENERAL', 'DAO'].map(c => (
                <button key={c} onClick={()=>{setActiveChan({id: c.toLowerCase(), name: c}); setTargetPM(null)}} className={`w-full text-left p-2 text-xs font-bold ${!targetPM && activeChan.name === c ? 'text-red-600' : 'text-gray-500'}`}># {c}</button>
              ))}
              <p className="text-[10px] text-gray-500 font-bold uppercase mt-4">Privados (E3EE)</p>
              {onlineUsers.filter(u => u.uid !== user.uid).map(u => (
                <button key={u.uid} onClick={() => setTargetPM(u)} className={`w-full text-left p-2 text-[11px] truncate ${targetPM?.uid === u.uid ? 'text-yellow-500' : 'text-gray-400'}`}>● {u.username}</button>
              ))}
            </div>
          </aside>

          {/* CHAT */}
          <main className="flex-1 panel-3d flex flex-col overflow-hidden">
            <header className="h-16 flex items-center justify-between px-8 border-b border-white/5">
              <h2 className="text-xs font-black text-red-600 uppercase italic">/ {targetPM ? `PRIVADO: ${targetPM.username}` : activeChan.name}</h2>
              <button onClick={()=>{setIsDark(!isDark); document.body.className=isDark?'light-theme':'dark-theme'}} className="text-red-600"><i className={`fas ${isDark?'fa-sun':'fa-moon'}`}></i></button>
            </header>
            
            <div className="flex-1 overflow-y-auto p-6 flex flex-col gap-4 custom-scroll">
              {messages.map(m => {
                const isMe = m.userId === user.uid;
                const eKey = [user.uid, (isMe ? m.receiverId : m.userId)].sort().join('_');
                const content = m.type === 'private' ? (CryptoJS.AES.decrypt(m.content, eKey).toString(CryptoJS.enc.Utf8) || "[Cifrado]") : m.content;
                return (
                  <div key={m.id} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                    <span className="text-[9px] text-gray-500 mb-1">{m.username}</span>
                    <div className={`bubble-3d ${isMe ? 'me' : 'other'} ${m.type === 'private' ? 'private' : ''}`}>
                      {content}
                    </div>
                  </div>
                );
              })}
              <div ref={scrollRef}></div>
            </div>

            <div className="p-4 bg-black/20 flex gap-2">
              <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendMessage()} className="flex-1 bg-transparent border border-white/10 rounded-xl px-4 hacker-input text-sm outline-none" placeholder="Transmitir..." />
              <button onClick={sendMessage} className="w-12 h-12 bg-red-600 rounded-xl shadow-lg shadow-red-600/20"><i className="fas fa-paper-plane"></i></button>
            </div>
          </main>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
