<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Ultra Stable</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;900&display=swap');
    body { background: #050505; color: white; font-family: sans-serif; height: 100vh; margin: 0; }
    .panel-main { background: #0c0c0c; border: 1px solid rgba(255,0,0,0.1); border-radius: 20px; }
    .bubble { padding: 10px 15px; border-radius: 15px; font-size: 14px; margin-bottom: 5px; max-width: 80%; }
    .bubble.me { background: #ff0000; margin-left: auto; border-bottom-right-radius: 2px; }
    .bubble.other { background: #1a1a1a; margin-right: auto; border-bottom-left-radius: 2px; }
    .hacker-font { font-family: 'Fira Code', monospace; }
  </style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIG ---
    const CONTRACT_ADDR = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
    const VIP_WALLET = "0xBEec8F1fee64627F83F0188eAe621F367A6bCb8a".toLowerCase();
    const MIN_BAL = 1000000n * (10n ** 18n);
    const ABI = [{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

    const fbConf = {
      apiKey: atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),
      databaseURL: atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),
      projectId: atob('cHVsc2FyaQ==')
    };

    if (!firebase.apps.length) firebase.initializeApp(fbConf);
    const db = firebase.database();

    function App() {
      const [user, setUser] = useState(null);
      const [msgs, setMsgs] = useState([]);
      const [val, setVal] = useState("");
      const [showPriv, setShowPriv] = useState(false);
      const scrollRef = useRef();

      useEffect(() => {
        const addr = sessionStorage.getItem('muzz_wallet_address');
        if (!addr) { window.location.href = 'login.html'; return; }

        // Setup User
        const name = addr.startsWith('0x') ? `Node_${addr.slice(-4)}` : addr;
        setUser({ name, addr });

        // Firebase Auth
        firebase.auth().signInAnonymously();

        // Check Access (Sin bloquear el renderizado)
        const check = async () => {
          if (addr.toLowerCase() === VIP_WALLET) {
            setShowPriv(true);
            return;
          }
          try {
            if (window.ethereum) {
              const prov = new ethers.BrowserProvider(window.ethereum);
              const con = new ethers.Contract(CONTRACT_ADDR, ABI, prov);
              const b = await con.balanceOf(addr);
              if (b >= MIN_BAL) setShowPriv(true);
            }
          } catch (e) { console.log("Token gating check skipped/error"); }
        };
        check();
      }, []);

      useEffect(() => {
        const ref = db.ref('messages/general').limitToLast(40);
        ref.on('value', s => {
          const d = s.val();
          setMsgs(d ? Object.values(d) : []);
        });
        return () => ref.off();
      }, []);

      useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [msgs]);

      const send = () => {
        if (!val.trim()) return;
        db.ref('messages/general').push({
          content: val,
          username: user.name,
          sender: user.addr,
          ts: Date.now()
        });
        setVal("");
      };

      if (!user) return <div className="h-full flex items-center justify-center text-red-600">LOADING MUZZLE NODE...</div>;

      return (
        <div className="flex h-screen p-4 gap-4">
          {/* SIDEBAR */}
          <div className="w-64 panel-main p-6 hidden md:flex flex-col">
            <h1 className="font-orbitron font-black text-xl text-red-600 mb-8">MUZZSNAP</h1>
            <div className="flex-1 space-y-2">
              <button className="w-full text-left p-2 text-red-500 font-bold bg-red-500/10 rounded"># GENERAL</button>
              
              {showPriv && (
                <div className="mt-6 pt-6 border-t border-white/10">
                  <a href="private.html" className="flex items-center justify-center w-full p-3 bg-red-600 rounded-lg text-[10px] font-black uppercase hover:bg-red-700 transition-all shadow-lg">
                    <i className="fas fa-lock mr-2"></i> Private Archive
                  </a>
                </div>
              )}
            </div>
            <button onClick={() => {sessionStorage.clear(); location.href='login.html'}} className="p-2 text-[10px] text-gray-600 border border-gray-800 rounded uppercase">Logout</button>
          </div>

          {/* CHAT */}
          <div className="flex-1 panel-main flex flex-col overflow-hidden">
            <div className="p-4 border-b border-white/5 flex justify-between items-center">
              <span className="text-xs font-bold text-red-500 uppercase tracking-widest">/ general</span>
              <span className="text-[10px] text-gray-600">{user.addr.slice(0,10)}...</span>
            </div>

            <div className="flex-1 overflow-y-auto p-4 flex flex-col custom-scroll">
              {msgs.map((m, i) => (
                <div key={i} className={`flex flex-col ${m.sender === user.addr ? 'items-end' : 'items-start'} mb-4`}>
                  <span className="text-[8px] text-gray-500 uppercase mb-1">{m.username}</span>
                  <div className={`bubble ${m.sender === user.addr ? 'me' : 'other'}`}>
                    {m.content}
                  </div>
                </div>
              ))}
              <div ref={scrollRef}></div>
            </div>

            <div className="p-4 bg-black/40 border-t border-white/5 flex gap-2">
              <input 
                value={val}
                onChange={e => setVal(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && send()}
                placeholder="Message..."
                className="flex-1 bg-black/50 border border-white/10 rounded-xl px-4 py-2 text-sm hacker-font text-red-500 focus:outline-none focus:border-red-600"
              />
              <button onClick={send} className="w-12 h-12 bg-red-600 rounded-xl flex items-center justify-center shadow-lg hover:bg-red-500 transition-all">
                <i className="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
