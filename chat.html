<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>MuzzSnap - Terminal Edition</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;700&family=Orbitron:wght@400;900&display=swap');
    
    :root { --muzz-red: #ff0000; --ryachu-gold: #ffcc00; --itsuki-blue: #00d4ff; }

    /* FULLSCREEN FIX: Evita que el navegador corte los bordes */
    html, body { 
      height: 100dvh; /* Altura dinámica para móvil */
      overflow: hidden; 
      margin: 0; 
      padding: 0; 
      position: fixed; /* Bloquea el rebote del scroll en iOS/Android */
      width: 100%;
    }

    body.dark-theme { background: #050505; color: white; }
    body.light-theme { background: #f0f2f5; color: #1a1a1a; }

    #root { height: 100dvh; display: flex; flex-direction: column; }

    /* Layout de Paneles */
    .panel-3d { 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
      transition: all 0.3s ease;
      overflow: hidden;
    }

    @media (min-width: 1024px) {
      .app-wrapper { padding: 20px; gap: 20px; }
      .panel-3d { border-radius: 28px; border: 1px solid rgba(255,0,0,0.2); background: rgba(12,12,12,0.95); }
    }

    /* Burbujas Estilo App */
    .bubble-3d { padding: 10px 14px; border-radius: 18px; font-size: 14px; max-width: 85%; word-wrap: break-word; }
    .bubble-3d.me { background: linear-gradient(145deg, #ff0000, #b30000); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .dark-theme .bubble-3d.other { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.05); }

    .hacker-input { font-family: 'Fira Code', monospace; font-size: 16px !important; } /* 16px evita el zoom automático en iPhone */
    
    .custom-scroll::-webkit-scrollbar { width: 3px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: var(--muzz-red); border-radius: 10px; }

    /* Menu Trigger Mobile */
    .menu-trigger {
      width: 42px; height: 42px; border-radius: 12px;
      display: flex; items-center justify-center;
      background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.2);
      color: var(--muzz-red);
    }
  </style>
</head>
<body class="dark-theme">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari",
      storageBucket: "pulsari.firebasestorage.app",
      messagingSenderId: "824306321233",
      appId: "1:824306321233:web:2c9bfa02170a17d560b570"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function App() {
      const [user, setUser] = useState(null);
      const [messages, setMessages] = useState([]);
      const [inputText, setInputText] = useState("");
      const [isDark, setIsDark] = useState(true);
      const [showEmoji, setShowEmoji] = useState(false);
      const [isMobileMenu, setIsMobileMenu] = useState(false);
      const dummyRef = useRef(null);

      const toggleTheme = () => {
        setIsDark(!isDark);
        document.body.className = isDark ? 'light-theme' : 'dark-theme';
      };

      useEffect(() => {
        const sessionData = sessionStorage.getItem('muzz_wallet_address');
        if (!sessionData) { window.location.href = 'login.html'; return; }
        const isWallet = !sessionData.startsWith('guest_');
        const name = isWallet ? `Node_${sessionData.slice(-4)}` : sessionData.replace('guest_', '');
        setUser({ username: name, role: isWallet ? 'user' : 'guest' });

        const msgRef = database.ref('messages/general').limitToLast(30);
        msgRef.on('value', snap => {
          const data = snap.val();
          setMessages(data ? Object.keys(data).map(k => ({id:k, ...data[k]})) : []);
        });
        return () => msgRef.off();
      }, []);

      useEffect(() => { dummyRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const handleSend = () => {
        if (!inputText.trim()) return;
        database.ref('messages/general').push({
          content: inputText, username: user.username, timestamp: Date.now()
        });
        setInputText(""); setShowEmoji(false);
      };

      if (!user) return null;

      return (
        <div className="flex w-full h-full app-wrapper overflow-hidden lg:max-w-[1400px] lg:mx-auto">
          
          {/* SIDEBAR (Drawer en móvil) */}
          <aside className={`fixed lg:relative z-50 inset-y-0 left-0 w-72 lg:w-64 transition-transform duration-300 panel-3d p-6 flex flex-col ${isMobileMenu ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
            <h1 className="font-orbitron font-black text-red-600 mb-8 italic">MUZZSNAP</h1>
            <div className="flex-1 overflow-y-auto custom-scroll">
              <p className="text-[10px] text-gray-500 font-bold mb-4 uppercase">Protocol_Net</p>
              <button className="w-full text-left px-4 py-3 rounded-xl bg-red-600/10 text-red-600 font-bold text-xs"># GENERAL</button>
            </div>
            <button onClick={() => {sessionStorage.clear(); window.location.href='login.html'}} className="mt-4 p-3 bg-red-600/5 text-red-600 rounded-xl text-[10px] font-black uppercase">Disconnect</button>
          </aside>

          {/* CHAT AREA */}
          <main className="flex-1 panel-3d flex flex-col relative overflow-hidden">
            <header className="h-16 flex items-center justify-between px-4 md:px-8 border-b border-white/5 bg-black/20 flex-shrink-0">
              <div className="flex items-center gap-3">
                <button onClick={() => setIsMobileMenu(true)} className="lg:hidden menu-trigger">
                  <i className="fas fa-th-large"></i>
                </button>
                <span className="text-xs font-black text-red-600 tracking-widest italic">/ MAIN_NET</span>
              </div>
              <button onClick={toggleTheme} className="w-10 h-10 rounded-xl border border-red-600/20 flex items-center justify-center bg-black/20">
                {isDark ? <i className="fas fa-sun text-yellow-500"></i> : <i className="fas fa-moon text-blue-500"></i>}
              </button>
            </header>

            {/* Mensajes con scroll independiente */}
            <div className="flex-1 overflow-y-auto p-4 md:p-6 flex flex-col gap-4 custom-scroll">
              {messages.map(msg => (
                <div key={msg.id} className={`flex flex-col ${msg.username === user.username ? 'items-end' : 'items-start'}`}>
                  <span className="text-[8px] text-gray-500 mb-1 font-black uppercase tracking-tighter">{msg.username}</span>
                  <div className={`bubble-3d shadow-md ${msg.username === user.username ? 'me' : 'other'}`}>
                    {msg.content}
                  </div>
                </div>
              ))}
              <div ref={dummyRef}></div>
            </div>

            {/* Input fijo abajo (No se mueve) */}
            <div className={`p-4 md:p-6 ${isDark ? 'bg-black/40' : 'bg-gray-100'} border-t border-white/5 flex-shrink-0`}>
              <div className="flex items-center bg-black/20 border border-white/10 rounded-2xl p-2 pl-4 shadow-inner">
                <button onClick={() => setShowEmoji(!showEmoji)} className="text-gray-500 mr-2"><i className="far fa-laugh-beam"></i></button>
                <input 
                  value={inputText} 
                  onChange={e => setInputText(e.target.value)} 
                  onKeyDown={e => e.key === 'Enter' && handleSend()} 
                  placeholder="Transmit..." 
                  className="flex-1 bg-transparent border-none focus:ring-0 text-sm hacker-input" 
                />
                <button onClick={handleSend} className="w-10 h-10 bg-red-600 rounded-xl flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                  <i className="fas fa-paper-plane text-white text-xs"></i>
                </button>
              </div>
            </div>
          </main>

          {/* Overlay móvil */}
          {isMobileMenu && <div onClick={() => setIsMobileMenu(false)} className="fixed inset-0 bg-black/80 z-40 lg:hidden backdrop-blur-sm"></div>}
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
