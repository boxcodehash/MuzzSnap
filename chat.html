<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>MuzzSnap - Terminal Edition</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;900&display=swap');
    
    :root { --muzz-red: #ff0000; --ryachu-gold: #ffcc00; --itsuki-blue: #00d4ff; }

    /* FIX PANTALLA MOBILE DVH */
    html, body, #root { height: 100dvh; overflow: hidden; margin: 0; padding: 0; position: fixed; width: 100%; background: #050505; color: white; }

    .panel-3d { border-radius: 24px; display: flex; flex-direction: column; height: 100%; overflow: hidden; background: #0c0c0c; border: 1px solid rgba(255,0,0,0.15); box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
    
    .bubble-3d { padding: 12px 16px; border-radius: 20px; font-size: 14px; max-width: 85%; line-height: 1.4; position: relative; }
    .bubble-3d.me { background: linear-gradient(145deg, #ff0000, #b30000); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .bubble-3d.other { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.05); }

    .ryachu-name { color: var(--ryachu-gold); font-weight: 800; }
    .itsuki-name { color: var(--itsuki-blue); font-weight: 800; }

    .hacker-input { font-family: 'Fira Code', monospace; font-size: 16px !important; }
    .emoji-window { max-height: 180px; overflow-y: auto; display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; padding: 15px; }
    .emoji-btn { font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; display: flex; justify-content: center; }
    
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: var(--muzz-red); border-radius: 10px; }
    
    .online-indicator { width: 8px; height: 8px; background: #39ff14; border-radius: 50%; box-shadow: 0 0 8px #39ff14; }
    iframe { border: none; width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const ADMINS = {
      RYACHU: "0x208157b5ec396759e8754058108ecf53e32392ff".toLowerCase(),
      ITSUKI: "0x000".toLowerCase()
    };

    const EMOJIS = {
      "FACES": ["ðŸ˜Š","ðŸ˜‚","ðŸ˜‰","ðŸ˜","ðŸ˜˜","ðŸ˜›","ðŸ˜…","ðŸ˜¢","ðŸ˜­","ðŸ˜ ","ðŸ˜ˆ","ðŸ‘½","ðŸ¤–","ðŸ¤¡","ðŸ’€","ðŸ‘»","ðŸ’©"],
      "HANDS": ["ðŸ‘","ðŸ‘Ž","ðŸ‘Œ","âœŒï¸","ðŸ‘","ðŸ‘‹","ðŸ™","ðŸ’ª","â˜ï¸","ðŸ––"],
      "OBJECTS": ["â¤ï¸","â­","ðŸ”¥","ðŸ“š","ðŸ’»","ðŸ“±","ðŸ“·","ðŸ”‘","ðŸ”’","ðŸ’¡","ðŸ’°","ðŸ’Ž"]
    };

    const CHANNELS = [
      { id: "general", name: "GENERAL" },
      { id: "spanish", name: "ESPAÃ‘OL" }
    ];

    function App() {
      const [user, setUser] = useState(null);
      const [messages, setMessages] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      const [pinnedMsg, setPinnedMsg] = useState("");
      const [inputText, setInputText] = useState("");
      const [showEmoji, setShowEmoji] = useState(false);
      const [emojiTab, setEmojiTab] = useState("FACES");
      const [selectedChannel, setSelectedChannel] = useState(CHANNELS[0]);
      const [isMobileMenu, setIsMobileMenu] = useState(false);
      const [isMuted, setIsMuted] = useState(false);
      const dummyRef = useRef(null);

      useEffect(() => {
        const sessionData = sessionStorage.getItem('muzz_wallet_address');
        if (!sessionData) { window.location.href = 'login.html'; return; }

        firebase.auth().signInAnonymously().then((userCredential) => {
          const uid = userCredential.user.uid;
          const isWallet = !sessionData.startsWith('guest_');
          let name = "", role = "user";

          if (isWallet) {
            const w = sessionData.toLowerCase();
            if (w === ADMINS.RYACHU) { name = "Ryachu"; role = "ryachu"; }
            else if (w === ADMINS.ITSUKI) { name = "Itsuki"; role = "itsuki"; }
            else { name = `Node_${sessionData.slice(-4)}`; }
          } else {
            name = sessionData.replace('guest_', '');
            role = "guest";
          }

          setUser({ username: name, uid, role });

          // Listener de Blacklist (Mute/Kick)
          database.ref(`blacklist/${uid}`).on('value', snap => {
            if(snap.val() === 'kick') { alert("EXPULSADO POR ADMIN"); window.location.href='login.html'; }
            setIsMuted(snap.val() === 'mute');
          });

          database.ref(`status/${uid}`).onDisconnect().remove();
          database.ref(`status/${uid}`).set({ username: name, role, uid });
          database.ref('status').on('value', snap => setOnlineUsers(snap.val() ? Object.values(snap.val()) : []));
          database.ref('settings/pinned').on('value', snap => setPinnedMsg(snap.val() || ""));
        });
      }, []);

      useEffect(() => {
        if (!user || selectedChannel.id === 'swap') return;
        const msgRef = database.ref('messages/' + selectedChannel.id).limitToLast(50);
        msgRef.on('value', snap => {
          const data = snap.val();
          setMessages(data ? Object.keys(data).map(k => ({id:k, ...data[k]})) : []);
        });
        return () => msgRef.off();
      }, [selectedChannel, user]);

      useEffect(() => { dummyRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const handleSend = () => {
        if (!inputText.trim() || isMuted) return;
        database.ref('messages/' + selectedChannel.id).push({
          content: inputText, username: user.username, role: user.role, userId: user.uid, timestamp: Date.now()
        });
        setInputText(""); setShowEmoji(false);
      };

      const adminActions = {
        clearChat: () => { if(confirm("Â¿Limpiar historial?")) database.ref('messages/'+selectedChannel.id).remove(); },
        setPin: () => { const m = prompt("Mensaje superior:", pinnedMsg); if(m) database.ref('settings/pinned').set(m); },
        unpin: () => database.ref('settings/pinned').remove(),
        muteUser: (id) => database.ref(`blacklist/${id}`).set('mute'),
        kickUser: (id) => database.ref(`blacklist/${id}`).set('kick')
      };

      if (!user) return null;

      return (
        <div className="flex h-full w-full p-0 md:p-4 lg:p-6 gap-0 md:gap-6 overflow-hidden">
          
          {/* SIDEBAR */}
          <aside className={`fixed lg:relative z-50 inset-y-0 left-0 w-72 lg:w-64 transition-all duration-300 transform panel-3d p-6 flex flex-col ${isMobileMenu ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
            <div className="mb-8"><h1 className="font-orbitron font-black text-xl italic tracking-tighter uppercase">Muzz<span className="text-red-600 text-2xl">Snap</span></h1></div>

            <div className="flex-1 overflow-y-auto custom-scroll space-y-8">
              
              {/* ADMIN PANEL */}
              {(user.role === 'ryachu' || user.role === 'itsuki') && (
                <div>
                  <p className="text-[9px] text-red-600 font-bold mb-3 tracking-widest">ADMIN_CONSOLE</p>
                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={adminActions.setPin} className="text-[8px] bg-red-600/20 border border-red-600/40 py-2 rounded font-black">PIN</button>
                    <button onClick={adminActions.clearChat} className="text-[8px] bg-white/5 border border-white/10 py-2 rounded font-black">CLEAR</button>
                  </div>
                </div>
              )}

              {/* NAV SUBMENU */}
              <div>
                <p className="text-[10px] text-gray-500 font-bold mb-3 uppercase tracking-widest">Protocol_Nav</p>
                <div className="space-y-1">
                  <button onClick={() => window.location.href='social.html'} className="w-full text-left px-4 py-3 rounded-xl text-xs font-bold text-red-500 hover:bg-red-600/10 transition-all border border-red-600/20"><i className="fas fa-rss mr-3"></i> MUZZ FEED (P2P)</button>
                  <button onClick={() => {setSelectedChannel({id:'swap', name:'MUZZLE SWAP'}); setIsMobileMenu(false);}} className={`w-full text-left px-4 py-3 rounded-xl text-xs font-bold transition-all ${selectedChannel.id === 'swap' ? 'bg-orange-600 text-white shadow-lg shadow-orange-600/20' : 'text-orange-500 hover:bg-orange-500/10'}`}><i className="fas fa-bolt mr-3"></i> MUZZLE SWAP</button>
                </div>
              </div>

              {/* CHANNELS */}
              <div>
                <p className="text-[10px] text-gray-500 font-bold mb-3 uppercase tracking-widest">Channels</p>
                {CHANNELS.map(ch => (
                  <button key={ch.id} onClick={() => { setSelectedChannel(ch); setIsMobileMenu(false); }} 
                    className={`w-full text-left px-4 py-3 rounded-xl text-xs font-bold mb-1 transition-all ${selectedChannel.id === ch.id ? 'bg-red-600 text-white' : 'text-gray-400 hover:text-white'}`}>
                    # {ch.name}
                  </button>
                ))}
              </div>

              {/* ONLINE USERS */}
              <div>
                <p className="text-[10px] text-gray-500 font-bold mb-3 uppercase tracking-widest">Online â€” {onlineUsers.length}</p>
                <div className="space-y-3">
                  {onlineUsers.map((u, i) => (
                    <div key={i} className="flex items-center justify-between group">
                      <div className="flex items-center gap-2 overflow-hidden">
                        <span className="online-indicator"></span>
                        <span className={`text-[11px] truncate font-bold uppercase ${u.role === 'ryachu' ? 'ryachu-name' : u.role === 'itsuki' ? 'itsuki-name' : 'text-gray-400'}`}>{u.username}</span>
                      </div>
                      {(user.role === 'ryachu' || user.role === 'itsuki') && u.uid !== user.uid && (
                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button onClick={() => adminActions.muteUser(u.uid)} className="text-[8px] text-orange-500">MUTE</button>
                          <button onClick={() => adminActions.kickUser(u.uid)} className="text-[8px] text-red-600">KICK</button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <button onClick={() => {sessionStorage.clear(); window.location.href='login.html'}} className="mt-6 w-full py-3 text-[10px] border border-red-900/30 text-red-600 rounded-xl uppercase font-black hover:bg-red-600/5 transition-all">Disconnect</button>
          </aside>

          {/* MAIN CHAT / SWAP AREA */}
          <main className="flex-1 panel-3d relative bg-[#0c0c0c]">
            {pinnedMsg && selectedChannel.id !== 'swap' && (
              <div className="bg-red-600/10 border-b border-red-600/30 py-2 px-6 flex items-center justify-between flex-shrink-0">
                <div className="flex items-center gap-3 overflow-hidden">
                  <i className="fas fa-thumbtack text-red-600 text-[10px]"></i>
                  <marquee className="text-[10px] font-bold tracking-[0.2em] text-red-500 uppercase">{pinnedMsg}</marquee>
                </div>
                {(user.role === 'ryachu' || user.role === 'itsuki') && <button onClick={adminActions.unpin} className="text-red-600 ml-4"><i className="fas fa-times text-xs"></i></button>}
              </div>
            )}

            <header className="h-16 flex items-center justify-between px-6 border-b border-white/5 flex-shrink-0">
              <div className="flex items-center gap-4">
                <button onClick={() => setIsMobileMenu(true)} className="lg:hidden text-red-600"><i className="fas fa-bars text-xl"></i></button>
                <h2 className="text-xs font-black tracking-widest text-red-600 uppercase italic">/ {selectedChannel.name}</h2>
              </div>
            </header>

            {selectedChannel.id === 'swap' ? (
              /* NATIVE SWAP IFRAME */
              <div className="flex-1 relative bg-black">
                <div className="absolute inset-0 flex flex-col items-center justify-center opacity-20">
                    <i className="fas fa-circle-notch animate-spin text-orange-500 mb-2"></i>
                    <p className="text-[8px] font-orbitron">SECURE_BRIDGE_LOADING...</p>
                </div>
                <iframe 
                  src="https://app.uniswap.org/swap?&chain=eth&use=v2&outputCurrency=0xef3daa5fda8ad7aabff4658f1f78061fd626b8f0&inputCurrency=0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2"
                  style={{ filter: 'invert(1) hue-rotate(180deg) brightness(0.8) contrast(1.2)' }}
                ></iframe>
              </div>
            ) : (
              /* CHAT UI */
              <>
                <div className="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col gap-4 custom-scroll">
                  {messages.map(msg => (
                    <div key={msg.id} className={`flex flex-col ${msg.userId === user.uid ? 'items-end' : 'items-start'}`}>
                      <span className={`text-[10px] font-black mb-1 px-2 uppercase ${msg.role === 'ryachu' ? 'ryachu-name' : msg.role === 'itsuki' ? 'itsuki-name' : 'text-gray-500'}`}>{msg.username}</span>
                      <div className={`bubble-3d shadow-xl ${msg.userId === user.uid ? 'me' : 'other'}`}>{msg.content}</div>
                    </div>
                  ))}
                  <div ref={dummyRef}></div>
                </div>

                <div className="p-4 bg-black/40 border-t border-white/5 flex-shrink-0">
                  {showEmoji && (
                    <div className="mb-4 panel-3d border border-red-600/20 h-auto bg-black">
                      <div className="flex bg-white/5 border-b border-white/5 overflow-x-auto">
                        {Object.keys(EMOJIS).map(tab => (
                          <button key={tab} onClick={() => setEmojiTab(tab)} className={`px-4 py-2 text-[9px] font-black ${emojiTab === tab ? 'text-red-600' : 'text-gray-500'}`}>{tab}</button>
                        ))}
                      </div>
                      <div className="emoji-window custom-scroll">
                        {EMOJIS[emojiTab].map(e => (<span key={e} onClick={() => setInputText(inputText + e)} className="emoji-btn">{e}</span>))}
                      </div>
                    </div>
                  )}

                  <div className="flex items-center bg-black/50 border border-white/10 rounded-2xl p-2 pl-4 focus-within:border-red-600/50">
                    <button onClick={() => setShowEmoji(!showEmoji)} className="text-gray-500 mr-3"><i className="far fa-laugh-beam text-xl"></i></button>
                    <input 
                      disabled={isMuted}
                      value={isMuted ? "ESTÃS SILENCIADO" : inputText} 
                      onChange={e => setInputText(e.target.value)} 
                      onKeyDown={e => e.key === 'Enter' && handleSend()} 
                      placeholder={isMuted ? "CHAT DESACTIVADO" : "Transmit message..."} 
                      className="flex-1 bg-transparent border-none focus:ring-0 text-sm hacker-input text-white" 
                    />
                    <button onClick={handleSend} className="w-10 h-10 bg-red-600 rounded-xl flex items-center justify-center shadow-lg active:scale-95 transition-all"><i className="fas fa-paper-plane text-white text-xs"></i></button>
                  </div>
                </div>
              </>
            )}
          </main>
          {isMobileMenu && <div onClick={() => setIsMobileMenu(false)} className="fixed inset-0 bg-black/90 z-40 lg:hidden backdrop-blur-sm"></div>}
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
