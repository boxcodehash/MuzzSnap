<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MuzzSnap | Social</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="muzz-core.js"></script>

    <style>
        :root { --bg: #000; --border: #2f3336; }
        body { background: var(--bg); color: #e7e9ea; font-family: 'Inter', sans-serif; overflow: hidden; }
        /* Anti-inspección visual */
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [posts, setPosts] = useState([]);
            const [inputText, setInputText] = useState("");

            useEffect(() => {
                // Cargar datos iniciales usando el motor protegido
                setPosts(loadFromVault());

                // Sincronizar con el puente P2P
                syncBridge((newPost) => {
                    setPosts(prev => {
                        if (prev.find(p => p.id === newPost.id)) return prev;
                        const updated = [newPost, ...prev].slice(0, 50);
                        saveToVault(updated); // Guardar encriptado
                        return updated;
                    });
                });
            }, []);

            const handlePost = () => {
                const address = sessionStorage.getItem('muzz_wallet_address') || "0x000";
                database.ref('p2p_relay').push({
                    id: "m_" + Date.now(),
                    content: inputText,
                    username: `Node_${address.slice(-4)}`,
                    address: address,
                    timestamp: Date.now()
                });
                setInputText("");
            };

            return (
                <div className="max-w-[600px] mx-auto border-x border-[#2f3336] h-screen flex flex-col">
                    <header className="p-4 border-b border-[#2f3336] font-bold text-xl">MuzzSnap Node</header>
                    <div className="p-4 border-b border-[#2f3336]">
                        <textarea value={inputText} onChange={e => setInputText(e.target.value)} className="w-full bg-transparent border-none text-lg resize-none" placeholder="¿Qué hay en el lazo?" />
                        <button onClick={handlePost} className="bg-red-600 px-6 py-2 rounded-full font-bold float-right">Transmitir</button>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                        {posts.map(p => (
                            <div key={p.id} className="p-4 border-b border-[#2f3336] animate-pulse-once">
                                <div className="font-bold text-sm text-gray-500">@{p.address.slice(-4)}</div>
                                <div className="text-[15px]">{p.content}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

        // Bloqueo de teclas básicas de inspección
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && (e.key === 'u' || e.key === 's' || e.key === 'i')) e.preventDefault();
        });
    </script>
</body>
</html>
